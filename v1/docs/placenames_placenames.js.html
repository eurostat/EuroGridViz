<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: placenames/placenames.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: placenames/placenames.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// placenames are requested from an ArcGIS service provided by REGIO and are queried by using population thresholds according to the app's current scale

import * as CONSTANTS from "../constants.js";
import { json } from "d3-fetch";
import { CSS2DObject } from "../../lib/threejs/CSS2D/CSS2DRenderer";

/**
 * @description Adds placename labels to the viewer (via labelsLayer)
 * @param {Array} features Features returned by ArcGIS placename service
 * 
 */
 export function addPlacenameFeaturesToViewer(app, features) {
    for (let p = 0; p &lt; features.length; p++) {
        let pn = features[p];
        let name = pn.attributes[CONSTANTS.placenames.townField];
        let x, y, d;
        // x/y coordinates of each placename label
        if (app._isMobile) {
            if (app.zerosRemoved_) {
                d = Number('1E' + app.zerosRemoved_);
                x = app.viewer.mobileCoordScale(pn.geometry.x / d);
                y = app.viewer.mobileCoordScale(pn.geometry.y / d)
            } else {
                x = app.viewer.mobileCoordScale(pn.geometry.x);
                y = app.viewer.mobileCoordScale(pn.geometry.y);
            }
        } else {
            if (app.zerosRemoved_) {
                let d = Number('1E' + app.zerosRemoved_);
                x = pn.geometry.x / d;
                y = pn.geometry.y / d
            } else {
                x = pn.geometry.x;
                y = pn.geometry.y;
            }
        }
        let label = createPlacenameLabelObject(x, y, name);
        // TODO: group objects manually (THREE.group())
        app.labelsLayer.add(label);
    }
}

/**
 * @description Updates the placename labels accroding to the current zoom level
 * @param {*} scale
 * 
 */
 export function updatePlacenameLabels(app, scale) {
    //update thresholds according to current grid resolution
    app.placenameThresholds_ = defineDefaultPlacenameThresholds(app._currentResolution);
    if (scale > 0 &amp;&amp; scale &lt; app.viewer.camera.config.far_) {
        //placenames are added to the app.labelsLayer object
        getPlacenames(app).then(
            res => {
                removeAllLabelsFromLayer(app.labelsLayer);
                if (res.features) {
                    if (res.features.length > 0) {
                        addPlacenameFeaturesToViewer(app, res.features)
                    }
                }
            },
            err => {
                console.error(err);
            }
        );
    } else {
        removeAllLabelsFromLayer(app.labelsLayer);
    }
}

/**
   * @description Defines the default 'scale : population' thresholds which are used to generate the placename queries. E.g 10 : 10000 will define the population value of the placename query as 10 000 when the current app scale (or camera.position.z) is above 10 and below the next threshold.
   * @function defineDefaultPlacenameThresholds
   * @param {number} resolution
   */
export function defineDefaultPlacenameThresholds(resolution) {
    let r = resolution / window.devicePixelRatio;
    //let s = app.viewer.camera.camera.position.z;
    // scale : population
    return {
        [r * 1024]: 1000000,
        [r * 512]: 600000,
        [r * 256]: 500000,
        [r * 128]: 200000,
        [r * 64]: 150000,
        [r * 32]: 100000,
        [r * 16]: 50000,
        [r * 8]: 10000,
        [r * 4]: 5000,
        [r * 2]: 1000,
        [r]: 10,
    }
}

/**
   * @description Retrieves placenames by population according to the current scale, from an ArcGIS server endpoint (see constants for baseURL).
   * @function getPlacenames
   * @param {*} scale
   * @returns {Promise}
   */
export function getPlacenames(app) {
    let where = defineWhereParameter(app)
    let envelope = app.viewer.getCurrentGeoExtent(app);

    // if user has removed trailing zeros from x/y we add them back on for the placenames requests
    if (app.zerosRemoved_) {
        let d = Number('1E' + app.zerosRemoved_);
        envelope.xMin *= d,
            envelope.yMin *= d,
            envelope.xMax *= d,
            envelope.yMax *= d;
    }
    //currentExtent = envelope;
    //ESRI Rest API envelope: &lt;xmin>,&lt;ymin>,&lt;xmax>,&lt;ymax> (bottom left x,y , top right x,y)
    if (app.debugPlacenames_) console.info(envelope);

    if (envelope &amp;&amp; where) {
        let URL =
            CONSTANTS.placenames.baseURL +
            "where=" +
            where +
            "&amp;outSR=" +
            app.EPSG_ +
            "&amp;inSR=" + app.EPSG_ +
            "&amp;geometry=" +
            envelope.xMin +
            "," +
            envelope.yMin +
            "," +
            envelope.xMax +
            "," +
            envelope.yMax +
            "&amp;geometryType=esriGeometryEnvelope&amp;f=json&amp;outFields=" + CONSTANTS.placenames.townField + "," + CONSTANTS.placenames.populationField;

        //TODO: manage multiple calls by replicating angular's .unsubscribe() somehow
        let uri = encodeURI(URL);
        return json(uri);
    }
}

/**
 * 
 * 
 * @function removePlacenamesFromScene
 * @description Removes the placenames CSS2DObjects from the THREE pointsLayer layer
 */
export function removeAllLabelsFromLayer(labelsLayer) {
    if (labelsLayer &amp;&amp; labelsLayer.children.length > 0) {
        for (var i = labelsLayer.children.length - 1; i >= 0; i--) {
            labelsLayer.remove(labelsLayer.children[i]);
        }
    }
}


/**
 * @description Defines the WHERE part of the query sent to the placenames service
 * @function defineWhereParameter
 * @param {*} app
 */
function defineWhereParameter(app) {
    let scale = app.viewer.camera.camera.position.z;
    let r = app._currentResolution;
    let where = "";
    if (app.placenamesCountry_) {
        where = where + CONSTANTS.placenames.countryField + " = '" + app.placenamesCountry_ + "' AND "
    }
    // labelling thresholds by population - either custom values or by scale
    let popFilter = getPopulationParameterFromScale(app)
    if (app.debugPlacenames_) {
        console.info(popFilter);
    }
    return where + popFilter;
}

/**
 * @description Defines the population parameter for the request to the placenmes service. If app.populationThresholds_ are not set, it uses default thresholds
 * @function getPopulationParameterFromScale
 * @param {*} app
 */
function getPopulationParameterFromScale(app) {
    let scale = app.viewer.camera.camera.position.z;
    if (app._mobile) {
        //scale up to desktop values
        let factor = app.originalResolution / app._currentResolution
        scale = scale * factor;
    }

    let populationFieldName = CONSTANTS.placenames.populationField;
    //build query string from thresholds
    if (app.placenameThresholds_) {
        // always ascending order
        let scales = Object.keys(app.placenameThresholds_).sort((a, b) => { return parseInt(a) - parseInt(b) });
        let populations = Object.values(app.placenameThresholds_).sort((a, b) => { return parseInt(a) - parseInt(b) });
        for (let i = 0; i &lt; scales.length; i++) {
            let s = scales[i];
            let p = populations[i];



            if (scales[i + 1]) { //if not last threshold
                if (scale &lt; parseInt(scales[0])) { //below first threshold
                    return populationFieldName + ">" + p;
                } else if (scale > parseInt(s) &amp;&amp; scale &lt; parseInt(scales[i + 1])) {
                    // if current scale is between thresholds
                    return populationFieldName + ">" + p;
                }
            } else {
                // if last threshold
                return populationFieldName + ">" + p;
            }
        }
    }
}

/**
 * Creates a CSS2DObject for a placename ESRI JSON object
 *
 * @param {string} placename
 * @returns CSS2DObject
 */
export function createPlacenameLabelObject(x, y, placename) {
    var placeDiv = document.createElement("div");
    placeDiv.className = "gridviz-placename";
    placeDiv.textContent = placename;
    placeDiv.style.marginTop = "-1em";
    var placeLabel = new CSS2DObject(placeDiv);
    placeLabel.position.set(x, y, CONSTANTS.label_height);
    return placeLabel;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="Dataset.html">Dataset</a></li><li><a href="GeoJsonLayer.html">GeoJsonLayer</a></li><li><a href="GeoJsonLayer.exports.GeoJsonLayer.html">exports.GeoJsonLayer</a></li><li><a href="LabelsLayer.html">LabelsLayer</a></li><li><a href="LabelsLayer.exports.LabelsLayer.html">exports.LabelsLayer</a></li><li><a href="Layer.html">Layer</a></li><li><a href="Legend.exports.Legend.html">exports.Legend</a></li><li><a href="Style.html">Style</a></li><li><a href="Tooltip.exports.Tooltip.html">exports.Tooltip</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addButtonEvents">addButtonEvents</a></li><li><a href="global.html#addEventListeners">addEventListeners</a></li><li><a href="global.html#addGeoJson">addGeoJson</a></li><li><a href="global.html#addMouseEventsToView">addMouseEventsToView</a></li><li><a href="global.html#addPlacenameFeaturesToViewer">addPlacenameFeaturesToViewer</a></li><li><a href="global.html#addResizeEvent">addResizeEvent</a></li><li><a href="global.html#animate">animate</a></li><li><a href="global.html#appendTooltipContainer">appendTooltipContainer</a></li><li><a href="global.html#build">build</a></li><li><a href="global.html#colorLegend">colorLegend</a></li><li><a href="global.html#createLineFromCoords">createLineFromCoords</a></li><li><a href="global.html#createPlacenameLabelObject">createPlacenameLabelObject</a></li><li><a href="global.html#defineDefaultPlacenameThresholds">defineDefaultPlacenameThresholds</a></li><li><a href="global.html#defineWhereParameter">defineWhereParameter</a></li><li><a href="global.html#ensureTooltipOnScreen">ensureTooltipOnScreen</a></li><li><a href="global.html#getPlacenames">getPlacenames</a></li><li><a href="global.html#getPopulationParameterFromScale">getPopulationParameterFromScale</a></li><li><a href="global.html#hide">hide</a></li><li><a href="global.html#loadNuts2json">loadNuts2json</a></li><li><a href="global.html#ramp">ramp</a></li><li><a href="global.html#removePlacenamesFromScene">removePlacenamesFromScene</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#thresholdLabels">thresholdLabels</a></li><li><a href="global.html#updateLegend">updateLegend</a></li><li><a href="global.html#updatePlacenameLabels">updatePlacenameLabels</a></li><li><a href="global.html#validateAppConfiguration">validateAppConfiguration</a></li><li><a href="global.html#viewWholeGrid">viewWholeGrid</a></li><li><a href="global.html#zoom">zoom</a></li><li><a href="global.html#zoomIn">zoomIn</a></li><li><a href="global.html#zoomOut">zoomOut</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Tue Dec 07 2021 14:07:07 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
