<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title></title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="map" style="height: 100%; width: 100%"></div>

    <div style="
        position: absolute;
        left: 20px;
        top: 20px;
        width: auto;
        height: auto;
        padding: 10px;
        border: 0px;
        border-radius: 5px;
        background: #ffffffcc;
        line-height: 1.6;
        box-shadow: 5px 5px 5px grey;
    ">
        <div id="layer">
            <span style="font-size: 1.2em">
                <input type="radio" name="layer" id="pop" value="pop" checked />
                <label for="pop">Total population</label>
                <br />
                <input type="radio" name="layer" id="sex" value="sex" />
                <label for="sex">Sex</label>
                <br />
                <input type="radio" name="layer" id="emp" value="emp" />
                <label for="emp">Employment</label>
                <br />
                <input type="radio" name="layer" id="age" value="age" />
                <label for="age">Age</label>
                <br />
                <input type="radio" name="layer" id="mobility" value="mobility" />
                <label for="mobility">Mobility</label>
                <br />
                <input type="radio" name="layer" id="pob" value="pob" />
                <label for="pob">Birth place</label>
                <br />
            </span>
        </div>
        <span style="font-size: 1.2em">
            <hr />
            <input type="checkbox" id="label" checked />
            <label for="label">City names</label><br />
            <input type="checkbox" id="boundary" checked />
            <label for="boundary">Boundaries</label><br />
            <input type="checkbox" id="background" checked />
            <label for="background">Background</label>
        </span>
    </div>

    <script src="../../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
    <script>

        /*
        "T" >= Total population

        "F" >= Women
        "M" >= Men

        "Y_LT15" >= Age under 15 years
        "Y15-64" >= Age 15 to 64 years
        "Y_GE65" >= Age 65 years and older

        "EMP" >= Employed (working population)

        "NAT" >= Born in the country
        "EU_OTH" >= Born in another EU member state
        "OTH" >= Born outside the EU

        "SAME" >= Residence unchanged (as of January 1, 2021, compared to January 1, 2020)
        "CHG_IN" >= Moved within the Netherlands (as of January 1, 2021, compared to January 1, 2020)
        "CHG_OUT" >= Moved from outside the Netherlands (as of January 1, 2021, compared to January 1, 2020)
        */

        //define map with initial view
        const map = new gridviz.Map(document.getElementById('map'), { x: 4598000, y: 2715000, z: 700 })
            .setViewFromURL()

        const backgroundLayer1 = new gridviz.BackgroundLayer({
            url: 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/',
            resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
            origin: [0, 6000000],
            filterColor: () => '#ffffffc0',
            visible: (z) => z > 50,
        })

        const backgroundLayer2 = new gridviz.BackgroundLayer(
            gridviz_eurostat.giscoBackgroundLayer("OSMPositronBackground", 18, "EPSG3035", {
                visible: (z) => z <= 50,
            })
        )

        //define boundaries layer
        const boundariesLayer = new gridviz.GeoJSONLayer(gridviz_eurostat.getEurostatBoundariesLayer())

        //make label layer
        const labelLayer = new gridviz.LabelLayer(gridviz_eurostat.getEuronymeLabelLayer())

        //define multi resolution dataset
        const dataset = new gridviz.MultiResolutionDataset(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            resolution => new gridviz.TiledGrid(map, 'http://localhost:1234/' + resolution + 'm/'),
            {
                preprocess: (c) => {
                    if (!c.T || +c.T == 0) return false

                    //male/female index
                    //if (+c.F + +c.M != c.T) console.error("Error found in sex total")
                    c.indMF = +c.M - (+c.F)
                    c.indMF = (100 * c.indMF) / (+c.M + +c.F)
                    if (isNaN(c.indMF)) c.indMF = 0

                    //employment
                    c.remp = c.EMP / c.T * 100
                    if (c.remp < 0 || c.remp > 100) console.log("Unexpected employment rate: " + c.remp, c.EMP, c.T)
                    c.remp = c.remp > 100 ? 100 : c.remp < 0 ? 0 : c.remp
                }
            }
        )

        //make grid layer
        const gridLayer = new gridviz.GridLayer(dataset, [], {
            cellInfoHTML: (c) => '<b>' + c.T + '</b> person' + (+c.T == 1 ? '' : 's')
        })

        //add layers to map
        map.layers = [backgroundLayer1, backgroundLayer2, gridLayer, boundariesLayer, labelLayer]

        //
        const update = () => {
            //read GUI selection
            const layCode = document.querySelector('input[name="layer"]:checked').value

            //set style
            if (layCode === 'pop') {

                gridLayer.styles = [
                    new gridviz.ShapeColorSizeStyle({
                        color: (c, r, z, viewScale) => viewScale(c.T),
                        viewScale: gridviz.viewScaleColor({ valueFunction: (c) => +c.T, colorScale: d3.interpolateYlOrRd, stretching: gridviz.logarithmicScale(-7) }),
                        blendOperation: (z) => z < 100 ? "multiply" : "source-over",
                    }),
                    new gridviz.StrokeStyle({ visible: (z) => z < 50 }),
                ]

                gridLayer.styles[0].legends = [
                    new gridviz.ColorLegend({
                        title: "Population",
                        colorScale: d3.interpolateYlOrRd,
                        ticks: 4,
                        textScale: (t, vs) => vs?.invert(t),
                        tickFormat: Math.round
                    })
                ]

                gridLayer.minPixelsPerCell = 1.5

            } else if (layCode === 'sex') {

                const nb = 12
                gridLayer.styles = [
                    new gridviz.ShapeColorSizeStyle({
                        color: (c, r, z, viewScale) => viewScale.color(c.indMF),
                        size: (c, r, z, viewScale) => viewScale.size(c.T),
                        viewScale: gridviz.viewScaleCombination({
                            color: gridviz.viewScaleColorQuantile({ valueFunction: (c) => +c.indMF, classNumber: nb, colorScale: d3.interpolateSpectral }),
                            size: gridviz.viewScaleQuantile({ valueFunction: (c) => +c.T, classNumber: 6, minSizePix: 3, maxSizeFactor: 1.1 })
                        }),
                        shape: () => 'circle',
                        blendOperation: (z) => z < 50 ? "multiply" : "source-over",
                    }),
                ]

                /*gridLayer.styles[0].legends = [
                    new gridviz.ColorLegend({
                        title: "Sex balance",
                        colorScale: (t, vs) => d3.interpolateSpectral(Math.ceil(nb * t) / (nb - 1)),
                        ticks: nb + 1,
                        textScale: (t, vs) => {
                            //vs.invert(t)
                            return t
                        }
                    })
                ]*/

                gridLayer.minPixelsPerCell = 5

            } else if (layCode === 'emp') {

                gridLayer.styles = [
                    new gridviz.ShapeColorSizeStyle({
                        color: (c, r, z, viewScale) => viewScale.color(c.remp),
                        size: (c, r, z, viewScale) => viewScale.size(c.T),
                        viewScale: gridviz.viewScaleCombination({
                            color: gridviz.viewScaleColorQuantile({ valueFunction: (c) => +c.remp, classNumber: 12, colorScale: d3.interpolateYlOrRd }),
                            size: gridviz.viewScaleQuantile({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 3, maxSizeFactor: 1.1 })
                        }),
                        shape: () => 'circle',
                        blendOperation: (z) => z < 50 ? "multiply" : "source-over",
                    })
                ]

                gridLayer.minPixelsPerCell = 5

            } else if (layCode === 'age') {

                const colAge = d3.interpolateSpectral
                gridLayer.styles = [
                    new gridviz.CompositionStyle({
                        color: {
                            Y_LT15: colAge(0.2),
                            "Y15-64": colAge(0.4),
                            Y_GE65: colAge(0.9),
                        },
                        type: () => 'flag',
                        size: (c, r, z, scale) => scale(+c.T),
                        viewScale: gridviz.viewScaleQuantile({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 8 }),
                        //viewScale: gridviz.sizeScale({ valueFunction: (c) => +c.T, exponent: 0.1 }),
                        stripesOrientation: () => 90,
                        blendOperation: (z) => z < 50 ? "multiply" : "source-over",
                    })
                    ,
                ]

                gridLayer.minPixelsPerCell = 12

            } else if (layCode === 'mobility') {

                gridLayer.styles = [
                    new gridviz.CompositionStyle({
                        color: {
                            SAME: "#fed9a6", //light mostard
                            CHG_IN: "#7570b3", //blueish
                            CHG_OUT: "#d95f02", //orange
                        },
                        type: () => 'piechart', //flag, piechart, ring, segment, radar, agepyramid, halftone
                        size: (c, r, z, scale) => scale(+c.T),
                        viewScale: gridviz.viewScaleQuantile({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 8 }),
                        blendOperation: (z) => z < 50 ? "multiply" : "source-over",
                    })
                ]

                gridLayer.minPixelsPerCell = 12

            } else if (layCode === 'pob') {

                gridLayer.styles = [
                    new gridviz.CompositionStyle({
                        color: {
                            NAT: "#fed9a6", //light mostard
                            EU_OTH: "#7570b3", //blueish
                            OTH: "#d95f02", //orange
                        },
                        type: () => 'halftone', //flag, piechart, ring, segment, radar, agepyramid, halftone
                        size: (c, r, z, scale) => scale(+c.T),
                        viewScale: gridviz.viewScaleQuantile({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 8 }),
                        blendOperation: (z) => z < 50 ? "multiply" : "source-over",
                    })
                ]

                gridLayer.minPixelsPerCell = 12

            } else console.error('Unexpected layer code: ' + layCode)

            //redraw
            map.redraw()
        }


        //layer update
        document.querySelector('#layer').addEventListener('change', update)

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            labelLayer.visible = () => this.checked
            map.redraw()
        })

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            boundariesLayer.visible = () => this.checked
            map.redraw()
        })

        // show/hide background layer
        document.querySelector('#background').addEventListener('change', function () {
            if (this.checked) {
                backgroundLayer1.visible = (z) => z > 50
                backgroundLayer2.visible = (z) => z <= 50
            } else {
                backgroundLayer1.visible = () => false
                backgroundLayer2.visible = () => false
            }
            map.redraw()
        })

        //select layer from URL
        const ls = gridviz.getParameterByName('lay')
        if (ls) {
            const b = document.querySelector('#' + ls)
            if (b) b.checked = true
        }

        //initialise
        update()


    </script>
    <div style="
    position: absolute;
    right: 0px;
    bottom: 0px;
    width: auto;
    height: auto;
    padding: 1px;
    border: 0px;
    background: #ffffffcc;
">
        <span style="font-size: 0.8em">
            <a href="https://github.com/eurostat/gridviz" style="text-decoration: none">GridViz</a> |
            ©<a href="https://eurogeographics.org" style="text-decoration: none">EuroGeographics</a></span>
    </div>


</body>

</html>