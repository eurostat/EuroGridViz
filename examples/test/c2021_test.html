<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title>Gridviz - Custom style</title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <script src="../../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>

    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
    <script>
        let containerDiv = document.getElementById('viz-container')

        const nbCl = 12
        const col = d3.scaleQuantile().range(Array.from({ length: nbCl }, (_, i) => d3.interpolateYlOrRd(i / (nbCl - 1))))

        const styleT = new gviz.ShapeColorSizeStyle_({
            color: (c, r, zf, vc) => vc.colR(c.T),
            viewContext: (cells, r, zf) => {
                col.domain(cells.map((c) => c.T));
                return { colR: col };
            }
        })

        const styleSex = new gviz.ShapeColorSizeStyle_({
            color: (c, r, zf, vc) => vc.colR(c.T),
            viewContext: (cells, r, zf) => {
                col.domain(cells.map((c) => c.T));
                return { colR: col };
            }
        })

        const style = styleSex

        /*
        
                                new gviz.ShapeColorSizeStyle({
                                    colorCol: 'I',
                                    color: (v, r, s) => {
                                        const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                                        const t = (Math.sign(v) * gviz.sPow(Math.abs(v) / max, 0.2)) / 2 + 0.5
                                        return d3.interpolateSpectral(1 - t)
                                    },
                                    shape: () => 'circle',
                                    sizeCol: 'TOT',
                                    size: (v, r, s, zf) => 1.3 * r * gviz.sPow(v / s.max, 0.2),
                                    blendOperation: (zf) => zf < 4 ? "multiply" : "source-over"
                                }),
        
        */

        /*
        "T" >= Total population
        "F" >= Women
        "M" >= Men
        "Y_LT15" >= Age under 15 years
        "Y15-64" >= Age 15 to 64 years
        "Y_GE65" >= Age 65 years and older
        "EMP" >= Employed (working population)
        "NAT" >= Born in the Netherlands
        "EU_OTH" >= Born in another EU member state
        "OTH" >= Born outside the EU
        "SAME" >= Residence unchanged (as of January 1, 2021, compared to January 1, 2020)
        "CHG_IN" >= Moved within the Netherlands (as of January 1, 2021, compared to January 1, 2020)
        "CHG_OUT" >= Moved from outside the Netherlands (as of January 1, 2021, compared to January 1, 2020)
        */



        //make application with custom style
        new gviz.App(containerDiv)
            .setGeoCenter({ x: 4598000, y: 2715000 })
            .setZoomFactor(700)
            .addMultiScaleTiledGridLayer(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'http://localhost:1234/' +
                    r +
                    'm/',
                [style],
                {
                    pixNb: 4,
                    preprocess: (c) => {
                        if (!c.T) return false

                        if (+c.F + +c.M != c.T) console.error("Error found in sex total")
                        c.indMF = +c.M - +c.F
                        c.indMF = (100 * c.indMF) / c.T
                        if (isNaN(c.indMF)) c.indMF = 0
                    }
                }

            )

    </script>
</body>

</html>