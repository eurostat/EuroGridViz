<!DOCTYPE html>
<html lang="en" style="height: 100%">
    <head>
        <meta charset="utf-8" />
        <title>Census demo</title>
        <meta content="width=device-width,initial-scale=1" name="viewport" />
        <meta content="IE=edge" http-equiv="X-UA-Compatible" />
        <script>
            var cl = document.querySelector('html').classList
            cl.remove('no-js')
            cl.add('has-js')
        </script>
        <link
            rel="stylesheet"
            href="https://cdn1.fpfis.tech.ec.europa.eu/ecl/v3.7.1/ec/styles/ecl-ec.css"
            integrity="sha256-I0/BnlrDCgIBe/HVW7FgKzkKiS0aUYobVacFdMDtcBE= sha384-GhNsxvo1nhuyhc2GCq1MrtBBkpWINHv70NHvJSAJcc+TJVtLtzwPIM0LkeO1KJjV
sha512-Ig1Qe8A0LuSgPWs1TsBVFTqRzgd9fe5BzwVLYuIGwETOpp3cvrZ3UJe93ty+BEVOZCKfKL/X4EcmXS7LUDVV4A=="
            crossorigin="anonymous"
            media="screen"
        />

        <!-- custom styles -->
        <style>
            .toc-element {
                margin-top: 0rem !important;
            }

            #gridviz-zoom-btns {
                position: absolute;
                right: 10px;
                top: 10px;
                width: auto;
                height: auto;
                font-size: 20px;
                font-weight: bold;
            }

            .gridviz-zoom-button {
                align-items: center;
                justify-content: center;
                width: 30px;
                height: 30px;
                display: flex;
                border: none;
                color: black;
                text-align: center;
                text-decoration: none;
                padding: 4px;
            }

            #gridviz-attribution {
                position: absolute;
                left: 0px;
                bottom: 0px;
                width: auto;
                height: auto;
                padding: 1px;
                border: 0px;
                background: #ffffffcc;
            }

            #legendPop {
                position: absolute;
                right: 10px;
                bottom: 10px;
                padding: 5px;
            }

            #legendPop text {
                display: inline-flex;
                font: normal normal 400 1rem/1.5rem arial, sans-serif;
                font-weight: 700 !important;
                font-size: 15px !important;
                fill: #404040;
            }

            #legendPop g text {
                font-weight: normal !important;
            }

            #tooltip_eurostat {
                box-shadow: 0 2px 4px rgba(0, 47, 103, 0.08), 0 0 10px rgba(0, 47, 103, 0.04),
                    0 4px 5px rgba(0, 47, 103, 0.04), 0 -4px 4px rgba(0, 47, 103, 0.04) !important;
                background-color: white !important;
                border-radius: 0px !important;
                /* border: 2px solid #004494 !important; */
            }
        </style>
    </head>

    <body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
        <div id="vizPop" style="position: relative; height: 630px; width: 900px">
            <!-- TABLE OF CONTENTS USING ECL COMPONENTS-->
            <div id="ecl-toc" style="left: 10px; top: 10px; position: absolute">
                <div class="toc-element" style="display: flex; margin-bottom: 0.5rem; margin-top: 0.5rem">
                    <div class="ecl-select__container ecl-select__container--m" style="max-width: 800px">
                        <select class="ecl-select" id="city" style="padding: 5px"></select>

                        <div class="ecl-select__icon">
                            <svg
                                class="ecl-icon ecl-icon--s ecl-icon--rotate-180 ecl-select__icon-shape"
                                focusable="false"
                                aria-hidden="true"
                            >
                                <use xlink:href="./ec-icons.svg#corner-arrow"></use>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gridviz-zoom-btns" class="ecl-u-bg-white ecl-u-shadow-3">
                <a id="zoomin" class="gridviz-zoom-button" href="#" title="Zoom in">+</a>
                <hr style="margin: 0px" />
                <a id="zoomout" class="gridviz-zoom-button" href="#" title="Zoom out">−</a>
            </div>

            <div id="legendPop" class="ecl-u-bg-white ecl-u-shadow-3"></div>

            <!-- <div
        id="legendPop"
        style="
          position: absolute;
          right: 5px;
          top: 5px;
          width: auto;
          height: auto;
          padding: 0px;
          border: 0px;
          border-radius: 5px;
          background: #ffffffdd;
          line-height: 1.6;
          box-shadow: 5px 5px 5px grey, -3px -3px 3px #ddd;
        "
      ></div> -->

            <div id="gridviz-attribution">
                <span style="font-size: 0.8em; font-family: sans-serif"
                    ><a
                        target="_blank"
                        rel="nofollow noreferrer noopener"
                        href="https://github.com/eurostat/gridviz"
                        style="text-decoration: none"
                        >GridViz</a
                    >
                    | ©
                    <a
                        target="_blank"
                        rel="nofollow noreferrer noopener"
                        href="https://eurogeographics.org"
                        style="text-decoration: none"
                        >EuroGeographics</a
                    >
                    | ©
                    <a
                        target="_blank"
                        rel="nofollow noreferrer noopener"
                        href="https://www.tuik.gov.tr"
                        style="text-decoration: none"
                        >Turkstat</a
                    >
                </span>
            </div>
        </div>

        <script src="../dist/gridviz.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@1.0.0"></script>
        <script src="https://ec.europa.eu/assets/estat/E/E4/gisco/ure2023/d3-color.js"></script>
        <script src="https://ec.europa.eu/assets/estat/E/E4/gisco/ure2023/d3-interpolate.js"></script>
        <script src="https://ec.europa.eu/assets/estat/E/E4/gisco/ure2023/d3-scale-chromatic.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
            integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn1.fpfis.tech.ec.europa.eu/ecl/v3.7.1/ec/scripts/ecl-ec.js"
            integrity="sha256-85iYkyKf920cTANsUWX4YyMFrXVpusH1jr7D+f7yP8Y= sha384-+Bn+9hyc3brumdCNjOgARtI1yEYpiFFy9GoPZVCC7zRge/EzQB3zoq73T8+SQmmR
    sha512-0Im3Z1WeMCohDjcEsobMJM4mYSBh2iHqj04ex0Dmeqf1TTa6wvhNDC+cQasWaMp6TJfHHdvbMG0ulHQ9LHZpXg=="
            crossorigin="anonymous"
        ></script>
        <script>
            ECL.autoInit()
        </script>
        <script>
            const nuts2jsonURL = 'https://raw.githubusercontent.com/eurostat/Nuts2json/master/pub/v2/' //"https://ec.europa.eu/assets/estat/E/E4/gisco/pub/nuts2json/v2/"
            const euronymURL = 'https://raw.githubusercontent.com/eurostat/euronym/main/pub/v2/UTF/' //"https://ec.europa.eu/assets/estat/E/E4/gisco/pub/euronym/v2/UTF/"
            const tiledGridsURL = 'https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/' //"https://ec.europa.eu/eurostat/cache/GISCO/urbanrural/grid_data/europe/"
            const bgLayerURL = 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/' //"https://ec.europa.eu/eurostat/cache/GISCO/urbanrural/background/elevation_shading/"
            const boundaryColor = '#888'

            let containerDiv = document.getElementById('vizPop')

            //prevent tooltip when mouseover TOC, legend and zoom buttons
            let tt = document.getElementById('tooltip_eurostat')
            let toc = document.getElementById('ecl-toc')
            let zoomBtns = document.getElementById('gridviz-zoom-btns')
            let lgndNode = document.getElementById('legendPop')
            ;[toc, zoomBtns, lgndNode].forEach((node) => {
                node.addEventListener('mouseenter', (event) => {
                    document.getElementById('tooltip_eurostat').style.display = 'none'
                    event.stopImmediatePropagation()
                })
                node.addEventListener('mouseleave', (event) => {
                    document.getElementById('tooltip_eurostat').style.display = 'block'
                    event.stopImmediatePropagation()
                })
            })

            const capitalsData = [
                {
                    cnt: 'Austria',
                    na: 'Vienna',
                    y: 2808634,
                    x: 4793921,
                },
                {
                    cnt: 'Belgium',
                    na: 'Brussels',
                    y: 3096992,
                    x: 3923720,
                },
                {
                    cnt: 'Bulgaria',
                    na: 'Sofia',
                    y: 2273273,
                    x: 5409208,
                },
                {
                    cnt: 'Croatia',
                    na: 'Zagreb',
                    y: 2539190,
                    x: 4785799,
                },
                {
                    cnt: 'Cyprus',
                    na: 'Nicosia',
                    y: 1669195,
                    x: 6434396,
                },
                {
                    cnt: 'Czech Republic',
                    na: 'Prague',
                    y: 3006573,
                    x: 4636888,
                },
                {
                    cnt: 'Denmark',
                    na: 'Copenhagen',
                    y: 3621928,
                    x: 4483714,
                },
                {
                    cnt: 'Estonia',
                    na: 'Tallinn',
                    y: 4124112,
                    x: 5152541,
                },
                {
                    cnt: 'Finland',
                    na: 'Helsinki',
                    y: 4206169,
                    x: 5145398,
                },
                {
                    cnt: 'France',
                    na: 'Paris',
                    y: 2889710,
                    x: 3759848,
                },
                {
                    cnt: 'Germany',
                    na: 'Berlin',
                    y: 3272768,
                    x: 4550204,
                },
                {
                    cnt: 'Greece',
                    na: 'Athens',
                    y: 1763405,
                    x: 5528486,
                },
                {
                    cnt: 'Hungary',
                    na: 'Budapest',
                    y: 2750854,
                    x: 5001006,
                },
                {
                    cnt: 'Ireland',
                    na: 'Dublin',
                    y: 3480833,
                    x: 3248170,
                },
                {
                    cnt: 'Italy',
                    na: 'Rome',
                    y: 2091787,
                    x: 4526939,
                },
                {
                    cnt: 'Latvia',
                    na: 'Riga',
                    y: 3845092,
                    x: 5173781,
                },
                {
                    cnt: 'Lithuania',
                    na: 'Vilnius',
                    y: 3613097,
                    x: 5298216,
                },
                {
                    cnt: 'Luxembourg',
                    na: 'Luxembourg City',
                    y: 2951645,
                    x: 4041344,
                },
                {
                    cnt: 'Malta',
                    na: 'Valleta',
                    y: 1438231,
                    x: 4731692,
                },
                {
                    cnt: 'Netherlands',
                    na: 'Amsterdam',
                    y: 3263159,
                    x: 3974055,
                },
                {
                    cnt: 'Poland',
                    na: 'Warsaw',
                    y: 3293412,
                    x: 5069599,
                },
                {
                    cnt: 'Portugal',
                    na: 'Lisbon',
                    y: 1946680,
                    x: 2665444,
                },
                {
                    cnt: 'Romania',
                    na: 'Bucharest',
                    y: 2507304,
                    x: 5594357,
                },
                {
                    cnt: 'Slovakia',
                    na: 'Bratislava',
                    y: 2806628,
                    x: 4849403,
                },
                {
                    cnt: 'Slovenia',
                    na: 'Ljubljana',
                    y: 2559306,
                    x: 4670065,
                },
                {
                    cnt: 'Spain',
                    na: 'Madrid',
                    y: 2029857,
                    x: 3159389,
                },
                {
                    cnt: 'Sweden',
                    na: 'Stockholm',
                    y: 4051033,
                    x: 4780334,
                },
            ]

            //build list
            const cityGUI = document.getElementById('city')

            for (let i = 0; i < capitalsData.length; i++) {
                const cap = capitalsData[i]
                const node = document.createElement('option')
                node.setAttribute('value', i)
                node.innerText = cap.cnt + ' - ' + cap.na
                cityGUI.appendChild(node)
            }

            const app = new gviz.App(containerDiv, {
                h: 630,
                w: 900,
                legendDivId: 'legendPop',
            })
                .setGeoCenter({ x: 4313947, y: 2970049 })
                .setZoomFactor(600)
                .setZoomFactorExtent([40, 7500])
                .setLabelLayer(
                    gviz_es.getEuronymeLabelLayer('EUR', 50, {
                        ccIn: [
                            'AT',
                            'BE',
                            'BG',
                            'CY',
                            'CZ',
                            'DE',
                            'DK',
                            'EE',
                            'ES',
                            'FI',
                            'FR',
                            'GR',
                            'HR',
                            'HU',
                            'IE',
                            'IT',
                            'LT',
                            'LU',
                            'LV',
                            'PL',
                            'PT',
                            'MT',
                            'NL',
                            'RO',
                            'SE',
                            'SK',
                            'SI',
                            'CH',
                            'IS',
                            'NO',
                            'LI',
                            'RS',
                            'XK',
                            'AL',
                            'TR',
                            'ME',
                            'MK',
                        ],
                        baseURL: euronymURL,
                    })
                )
                .setBoundaryLayer(
                    gviz_es.getEurostatBoundariesLayer({
                        baseURL: nuts2jsonURL,
                        showOth: false,
                        color: (f, zf) => {
                            const p = f.properties
                            if (p.id >= 100000) return '#bcbcbc'
                            if (p.co === 'T') return '#888'
                            if (zf < 400) return '#888'
                            else if (zf < 1000) return p.lvl >= 3 ? '' : '#888'
                            else if (zf < 2000) return p.lvl >= 2 ? '' : '#888'
                            else return p.lvl >= 1 ? '' : '#888'
                        },
                    })
                )
                .addBackgroundLayer({
                    url: bgLayerURL,
                    resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
                    origin: [0, 6000000],
                    filterColor: (zf) => '#ffffffc0',
                })

            //load dataset
            const popDataset = app.makeMultiScaleTiledGridDataset(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) => tiledGridsURL + 'population2/' + r + 'm/',
                {
                    preprocess: (c) => {
                        //console.log(c)
                        //if (c.CNTR_ID == "UK") return false;
                        //if (c.CNTR_ID == "0-UK") return false;
                        //if (c.CNTR_ID == "BA") return false
                        //if (c.CNTR_ID == "IM") return false;
                        //console.log(c.CNTR_ID)
                        //delete c.CNTR_ID;
                    },
                }
            )

            const popCol = "TOT_P_2021"

            //set default background filter color
            app.bgLayers[0].filterColor = (zf) => '#ffffffc0'

            const colR = d3.interpolateOrRd

            //add layer
            app.addLayerFromDataset(
                popDataset,
                [
                    new gviz.SquareColorWGLStyle({
                        colorCol: popCol,
                        color: colR,
                        stretching: { fun: 'expRev', alpha: -7 },
                    }),
                    new gviz.StrokeStyle({
                        strokeColorCol: popCol,
                        strokeColor: (v) => (+v ? '#666' : ''),
                        maxZoom: 80,
                    }),
                ],
                {
                    pixNb: 1.8,
                    cellInfoHTML: (c, r) =>
                        +c[popCol]
                            ? '<b>' +
                              c[popCol] +
                              '</b> inhabitant' +
                              (+c[popCol] == 1 ? '' : 's') +
                              ' per ' +
                              (r * r) / 1000000 +
                              'km²'
                            : undefined,
                }
            )

            //add legend
            app.layers[0].styles[0].legends.push(
                new gviz.ColorLegend({
                    title: 'Number of inhabitants',
                    width: 400,
                    ticks: 5,
                    colorRamp: colR,
                    fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                })
            )

            //
            const update = () => {
                //get city selection
                const city = cityGUI.value

                const cap = capitalsData[+city]
                app.setGeoCenter({ x: cap.x, y: cap.y }).setZoomFactor(120)

                //redraw
                app.cg.redraw()
            }

            //
            cityGUI.addEventListener('change', update)

            //zoom
            document
                .querySelector('#zoomin')
                .addEventListener('click', () => app.setZoomFactor(app.getZoomFactor() * 0.8).redraw())
            document
                .querySelector('#zoomout')
                .addEventListener('click', () => app.setZoomFactor(app.getZoomFactor() * 1.2).redraw())

            //initialise
            update()
        </script>
    </body>
</html>
