<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title>Gridviz - example</title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <div style="
        position: absolute;
        left: 20px;
        top: 20px;
        width: auto;
        height: auto;
        padding: 10px;
        border: 0px;
        border-radius: 5px;
        background: #ffffffcc;
        line-height: 1.6;
        box-shadow: 5px 5px 5px grey;
    ">
        <span style="font-size: 1.8em; font-weight: bold">Germany</span>
        <span style="font-size: 1.25em">
            <div id="layer">
                <input type="radio" name="layer" id="pop" value="pop" checked />
                <label for="pop">Total population</label>
                <br />
                <input type="radio" name="layer" id="popAge" value="popAge" />
                <label for="popAge">Population by age</label>
            </div>
            <hr />
            <input type="checkbox" id="label" checked />
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked />
            <label for="boundary">Boundaries</label>
            <hr />
            Source:
            <a href="https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html?nn=559100#Gitter"
                style="text-decoration: none">Statistisches Bundesamt, Wiesbaden 2018</a>
        </span>
    </div>



    <script src="../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridviz-parquet"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script>

        //https://www.npmjs.com/package/parquet-wasm
        const rp = (async () => {
            const parquetModule = await import(
                'https://unpkg.com/parquet-wasm@0.4.0-beta.5/esm/arrow2.js'
            )
            await parquetModule.default()
            return parquetModule.readParquet
        })().then((readParquet) => {
            let containerDiv = document.getElementById('viz-container')

            const app = new gviz.App(containerDiv)
                .setGeoCenter({ x: 4301000, y: 2889000 })
                .setZoomFactor(100)
                .setLabelLayer(gviz.getEuronymeLabelLayer('DE', '20'))
                .setBoundaryLayer(gviz.getEurostatBoundariesLayer())
                .addBackgroundLayerWMS({
                    url: 'https://sgx.geodatenzentrum.de/wms_basemapde?&service=WMS&request=GetMap&layers=de_basemapde_web_raster_grau&styles=&format=image%2Fjpeg&transparent=false&version=1.1.1&srs=EPSG%3A3035',
                    maxZoom: 50,
                })
                .addBackgroundLayer({
                    url: 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/',
                    resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
                    origin: [0, 6000000],
                    filterColor: (zf) => '#ffffff60',
                    minZoom: 50,
                })

            //prepare datasets, indexed by thematic domain and year
            const ds = {};
            const baseURL = 'https://raw.githubusercontent.com/jgaffuri/tiled-grid-germany-zensus2011/main/out/';

            const cleanCell = (c) => {
                for (let k of Object.keys(c)) c[k] = +(c[k] + "")
            };

            //create demography (population only) dataset
            ds.demo_pop = gviz_par.makeMultiScaleTiledParquetGridDataset(
                app,
                [100, 200, 500, 1000, 2000, 5000],
                (res) => baseURL + 'demo_pop/' + res + 'm/',
                {
                    readParquetFun: readParquet,
                    preprocess: (c) => { cleanCell(c) },
                })

            //create demography full dataset
            ds.demo = gviz_par.makeMultiScaleTiledParquetGridDataset(
                app,
                [100, 200, 500, 1000, 2000, 5000],
                (res) => baseURL + 'demo/' + res + 'm/',
                {
                    readParquetFun: readParquet,
                    preprocess: (c) => { cleanCell(c) },
                })


            //
            const update = () => {
                //read GUI selection
                const layCode = document.querySelector('input[name="layer"]:checked').value

                //remove layers
                app.layers = []

                //formater
                const f1 = d3.format('.1f')

                //set layer
                if (layCode === 'pop') {
                    app.addLayerFromDataset(
                        ds.demo_pop,
                        [
                            new gviz.SquareColorWGLStyle({
                                colorCol: 'pop',
                                color: d3.interpolateYlOrRd,
                                stretching: { fun: 'expRev', alpha: -7 },
                                //set alpha and blend operation
                                //alpha: (zf) => zf < 70 ? 0.75 : 1.0,
                                blendOperation: () => "multiply"
                            }),
                            new gviz.StrokeStyle({ maxZoom: 7 }),
                        ],
                        {
                            pixNb: 1.5,
                            cellInfoHTML: (c) => '<b>' + c.pop + '</b> person' + (+c.pop == 1 ? '' : 's')
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: "Population",
                            colorRamp: d3.interpolateYlOrRd,
                            fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                        })
                    )
                } else if (layCode === 'popAge') {
                    /*population by age (5 age groups)  ALTER_KURZ   1 Under 18     2 18 - 29    3 30 - 49    4 50 - 64   5 65 and over */
                    const col = d3.interpolateSpectral
                    app.addLayerFromDataset(
                        ds.demo,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    ALTER_KURZ_1: col(0.1),
                                    ALTER_KURZ_2: col(0.3),
                                    ALTER_KURZ_3: col(0.5),
                                    ALTER_KURZ_4: col(0.7),
                                    ALTER_KURZ_5: col(0.9),
                                },
                                type: () => 'flag', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'INSGESAMT_0',
                                size: (v, r, s, zf) => r * gviz.sPow(v / s.max, 0.25, 0),
                                stripesOrientation: () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: (zf) => "multiply"
                            }),
                        ],
                        {
                            pixNb: 14,
                            cellInfoHTML: (c) =>
                                '<b>' +
                                c.INSGESAMT_0 +
                                '</b> person' +
                                (+c.INSGESAMT_0 == 1 ? '' : 's') +
                                '<br>' +
                                'By age:<br>' +
                                ' < 18 : ' +
                                (c.ALTER_KURZ_1) +
                                '<br>' +
                                ' 18-29 : ' +
                                (c.ALTER_KURZ_2) +
                                '<br>' +
                                ' 30-49 : ' +
                                (c.ALTER_KURZ_3) +
                                '<br>' +
                                ' 50-64 : ' +
                                (c.ALTER_KURZ_4) +
                                '<br>' +
                                ' > 64: ' +
                                (c.ALTER_KURZ_5),
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Age',
                            colCat: [
                                [col(0.1), '< 18'],
                                [col(0.3), '18-29'],
                                [col(0.5), '30-49'],
                                [col(0.7), '50-64'],
                                [col(0.9), ' > 64'],
                            ].reverse(),
                        })
                    )
                } else console.error('Unexpected layer code: ' + layCode)

                //redraw
                app.cg.redraw()
            }

            //layer and year update
            document.querySelector('#layer').addEventListener('change', update)

            // show/hide labels
            document.querySelector('#label').addEventListener('change', function () {
                app.showLabels = this.checked
                app.cg.redraw()
            })

            // show/hide boundaries
            document.querySelector('#boundary').addEventListener('change', function () {
                app.showBoundaries = this.checked
                app.cg.redraw()
            })

            //select layer from URL
            const ls = gviz.getParameterByName('lay')
            if (ls) {
                const b = document.querySelector('#' + ls)
                if (b) b.checked = true
            }

            //initialise
            update()


            /*
            .addMultiScaleTiledGridLayer(
                [100, 200, 500, 1000, 2000, 5000, 10000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/germany/heizung/' +
                    r +
                    'm/',
                [
                    new gviz.CompositionStyle({
                        //x,y,Insg,fernw,etagen,zentral
                        color: {
                            fernw: '#7570b3cc', //purple
                            zentral: '#1b9e77cc', //green
                            etagen: '#d95f02cc', //orange
                            sonst: "#888888cc" //grey
                        },
                        type: () => 'piechart',
                        offsetAngle: () => 0,
                        sizeCol: "Insg",
                        size: (v, r, s, zf) => 1.1 * r * gviz.sPow(v / s.max, 0.2, 0),
                    }),
                ],
                {
                    pixNb: 12,
                    preprocess: (c) => {
                        c.fernw = +c.fernw
                        c.zentral = +c.zentral
                        c.etagen = +c.etagen
                        const a = c.Insg - c.fernw - c.etagen - c.zentral;
                        c.sonst = a < 0 ? 0 : a;
                    }
                }
            )
*/


        })


    </script>

    <div style="
    position: absolute;
    right: 0px;
    bottom: 0px;
    width: auto;
    height: auto;
    padding: 1px;
    border: 0px;
    background: #ffffffcc;
">
        <span style="font-size: 0.8em">
            <a href="https://github.com/eurostat/gridviz" style="text-decoration: none">GridViz</a> | ©<a
                href="https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html?nn=559100#Gitter"
                style="text-decoration: none">Statistisches Bundesamt,
                Wiesbaden 2018</a> |
            ©<a href="https://eurogeographics.org" style="text-decoration: none">EuroGeographics</a></span>
    </div>


</body>

</html>