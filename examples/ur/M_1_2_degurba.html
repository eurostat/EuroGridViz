<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="font-family: sans-serif;">
    <h1>Map 1.2</h1>
    <div id="vizDegurba" style="position:relative; height:600px; width:900px;">
        <div
            style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
            <span style="font-size: 0.8em; font-family: sans-serif;"><a href="https://github.com/eurostat/gridviz"
                    style="text-decoration:none">GridViz</a> |
                Â© <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
        </div>
    </div>
    <div id="legendDegurba" style="width: 200px;"></div>

    <script src="../../build/gridviz.js"></script>
    <script>

        const degurbaColors = {
            "uc": "#286eb4", //"#d53e4f", //Cities
            "du": "#286eb4", //"#f46d43", //Cities
            "sbu": "#c87e04", //"#fee08b", //Suburbs
            "sdu": "#fcc974", //"#fdae61", //Towns
            "r": "#468631", //"#fcc974", //"#e6f598", //Villages
            "lr": "#9dd58a", //"#abdda4", //Dispersed rural areas
            "vlr": "#c2d5bc", //"#66c2a5", //Mostly uninhabited areas
            "NA": "gray",
        }

        let containerDiv = document.getElementById("vizDegurba");
        const app = new gviz.App(containerDiv, { legendDivId: "legendDegurba" })
            .setGeoCenter({ x: 4313947, y: 2970049 }).setZoomFactor(2500).setZoomFactorExtent([40, 7500])
            .setLabelLayer(gviz.getEuronymeLabelLayer()).setBoundaryLayer(gviz.getEurostatBoundariesLayer())


        //population layer
        app.addMultiScaleTiledCSVGridLayer(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            r => "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/grid_pop_tiled/" + Math.round(r / 1000) + "km/",
            [
                new gviz.ShapeColorSizeStyle({
                    color: () => "#666",
                    sizeCol: "2018",
                    size: (v, r, s, zf) => 0.8 * r * gviz.sPow(v / s.max, 0.3),
                    shape: () => "circle",
                })
            ],
            {
                pixNb: 8,
                maxZoom: 80,
            }
        )


        //degurba layer
        app.addMultiScaleTiledCSVGridLayer(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            r => "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/degurba/tiled/" + r + "m/",
            [
                new gviz.CompositionStyle({
                    color: degurbaColors,
                    type: () => "flag",
                    //stripesOrientation: () => 0,
                    sizeCol: "TOT",
                    size: (v, r, s, z) => 1 * r * gviz.sPow(v / s.max, 0.5) + (z < 500 ? 0.8 * z : 0),
                    minZoom: 80,
                }),
                /*new gviz.SquareColorCatWGLStyle({
                    colorCol: "c",
                    color: degurbaColors,
                    maxZoom: 400,
                    minZoom: 120,
                }),*/
                new gviz.SideCatStyle({
                    col: "c",
                    color: degurbaColors,
                    width: (side, r, z) => z * 3,
                    fillColor: (c) => degurbaColors[c.c] + "55",
                    maxZoom: 80,
                }),
            ],
            {
                pixNb: 3.5,
                cellInfoHTML: c => {
                    if (!c.TOT) return "No information";
                    if (c.TOT == 1) return (
                        +c.uc ? "Large city" :
                            +c.du ? "City" :
                                +c.sbu ? "Suburb" :
                                    +c.sdu ? "Town" :
                                        +c.r ? "Village" :
                                            +c.lr ? "Dispersed rural" :
                                                +c.vlr ? "Mostly uninhabited" :
                                                    "Unknown");
                    const out = []
                    if (+c.uc) out.push(c.uc + " large city cell" + (+c.uc == 1 ? "" : "s") + "<br>")
                    if (+c.du) out.push(c.du + " city cell" + (+c.du == 1 ? "" : "s") + "<br>")
                    if (+c.sbu) out.push(c.sbu + " suburb cell" + (+c.sbu == 1 ? "" : "s") + "<br>")
                    if (+c.sdu) out.push(c.sdu + " town cell" + (+c.sdu == 1 ? "" : "s") + "<br>")
                    if (+c.r) out.push(c.r + " village cell" + (+c.r == 1 ? "" : "s") + "<br>")
                    if (+c.lr) out.push(c.lr + " dispersed rural cell" + (+c.lr == 1 ? "" : "s") + "<br>")
                    if (+c.vlr) out.push(c.vlr + " mostly uninhabited cell" + (+c.vlr == 1 ? "" : "s") + "<br>")
                    if (+c.NA) out.push(c.NA + " unknown cell" + (+c.NA == 1 ? "" : "s") + "<br>")
                    return out.join("")
                },
                preprocess: c => {
                    if (+c.TOT != 1) c.c = "zzz";
                    else
                        c.c = +c.uc ? "uc" : +c.du ? "du" : +c.sdu ? "sdu" : +c.sbu ? "sbu" : +c.r ? "r" : +c.lr ? "lr" : +c.vlr ? "vlr" : "NA";
                }
            })

            .addBackgroundLayer({
                url: "https://gisco-services.ec.europa.eu/maps/tiles/GreyEarth/EPSG3035/",
                resolutions: [156543.03392804097, 78271.51696402048, 39135.75848201024, 19567.87924100512, 9783.93962050256, 4891.96981025128, 2445.98490512564],
                origin: [0, 6000000],
                filterColor: zf => "#ffffffd3",
            })


        //population legend
        app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ shape: "circle", labelUnitText: "inhabitants", fillColor: "#666d" }))

        //degurba legend
        const catLeg = new gviz.ColorCategoryLegend({
            title: "Degree of urbanisation", colCat: [
                ["#286eb4", "City"],
                ["#c87e04", "Suburb"],
                ["#fcc974", "Town"],
                ["#468631", "Village"],
                ["#9dd58a", "Dispersed rural"],
                ["#c2d5bc", "Mostly uninhabited"],
            ],
            shape: "square",
        })
        app.layers[1].styles[0].legends.push(catLeg)
        app.layers[1].styles[1].legends.push(catLeg)

    </script>

</body>

</html>