<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="font-family: sans-serif;">
    <div id="vizAcc" style="position:relative; height:600px; width:900px;">

        <div
            style="font-size: 0.9em; position: absolute; left: 10px; top: 10px; width: auto; height: auto; padding: 5px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 3px 3px 3px grey">
            <input type="radio" name="serv" id="educ" value="educ">
            <label for="educ">Primary education</label>
            <br>
            <input type="radio" name="serv" id="health" value="health" checked>
            <label for="health">Health</label>
        </div>

        <div
            style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
            <span style="font-size: 0.8em; font-family: sans-serif;"><a target="_blank"
                    rel="nofollow noreferrer noopener" href="https://github.com/eurostat/gridviz"
                    style="text-decoration:none">GridViz</a> |
                Â© <a target="_blank" rel="nofollow noreferrer noopener" href="https://eurogeographics.org"
                    style="text-decoration:none">EuroGeographics</a></span>
        </div>
        <div id="legendAcc"
            style="position: absolute; left: 5px; bottom: 5px; width: auto; height: auto; padding: 0px; border: 0px; border-radius: 5px; background: #FFFFFFDD; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        </div>
    </div>

    <script src="../../build/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script>
        const nuts2jsonURL = "https://raw.githubusercontent.com/eurostat/Nuts2json/master/pub/v2/" //"https://ec.europa.eu/assets/estat/E/E4/gisco/pub/nuts2json/v2/"
        const euronymURL = "https://raw.githubusercontent.com/eurostat/euronym/main/pub/v2/UTF/" //"https://ec.europa.eu/assets/estat/E/E4/gisco/pub/euronym/v2/UTF/"
        const tiledGridsURL = "https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/" //"https://ec.europa.eu/eurostat/cache/GISCO/urbanrural/grid_data/europe/"
        const bgLayerURL = "https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/" //"https://ec.europa.eu/eurostat/cache/GISCO/urbanrural/background/elevation_shading/"

        let containerDiv = document.getElementById("vizAcc");
        const app = new gviz.App(containerDiv, { legendDivId: "legendAcc" })
            .setGeoCenter({ x: 4313947, y: 2970049 }).setZoomFactor(2500).setZoomFactorExtent([40, 7500])
            .setLabelLayer(
                gviz.getEuronymeLabelLayer("EUR", 50, {
                    ccIn: ["AT", "BE", "BG", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GR", "HR", "HU", "IE", "IT", "LT", "LU", "LV", "PL", "PT", "MT", "NL", "RO", "SE", "SK", "SI", "CH", "IS", "NO", "LI", "RS", "XK", "AL", "TR", "ME", "MK"],
                    baseURL: euronymURL,
                })
            )
            .setBoundaryLayer(gviz.getEurostatBoundariesLayer({
                baseURL: nuts2jsonURL,
            }))
            .addBackgroundLayer({
                url: bgLayerURL,
                resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
                origin: [0, 6000000],
                filterColor: zf => "#ffffffb0",
            })

        //accessibility dataset
        ds = app.makeMultiScaleTiledCSVGridDataset(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            r => tiledGridsURL + "accessibility/" + r + "m/",
            {
                preprocess: (c) => c.avg_time_nearest_h != "NA" || c.avg_time_nearest_ep != "NA"
            }
        )


        //common styles
        const strokeStyle = new gviz.StrokeStyle({ maxZoom: 70 });
        const popStyle = new gviz.ShapeColorSizeStyle({
            color: () => "#000000aa",
            sizeCol: "TOT_P",
            size: (v, r, s, zf) => 1.2 * r * gviz.sPow(v / s.max, 0.3),
            shape: () => "circle",
        })
        popStyle.legends.push(new gviz.SizeLegend({ shape: "circle", labelUnitText: "inhabitants", fillColor: "#000000dd" }))


        //
        const update = () => {

            //get service selection
            const serv = document.querySelector('input[name="serv"]:checked').value

            //remove layers
            app.layers = []

            if (serv == "health") {
                const breaks = [5, 10, 15, 20, 30, 45, 60, 90]
                const cFun = cid => gviz.sPow(1 - cid / breaks.length, 2)
                const cHTML = c => {
                    const txt = c.avg_time_nearest_h == "NA" ? "Unknown time" : "<b>" + c.avg_time_nearest_h + "</b> min."
                    return txt + " to nearest health service<br><b>" + c.TOT_P + "</b> person" + (+c.TOT_P == 1 ? "" : "s")
                }

                app.addLayerFromDataset(
                    ds,
                    [
                        new gviz.SquareColorWGLStyle({
                            colorCol: "avg_time_nearest_h",
                            color: d3.interpolateSpectral,
                            tFun: v => v == "NA" ? undefined : cFun(gviz.getClass(v, breaks))
                        }),
                        strokeStyle,
                    ],
                    {
                        pixNb: 1.5,
                        cellInfoHTML: cHTML,
                    }
                )
                app.addLayerFromDataset(
                    ds, [popStyle],
                    {
                        pixNb: 1.5,
                        maxZoom: 300,
                        cellInfoHTML: cHTML,
                    }
                )

                //legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorDiscreteLegend({
                        title: "Travel time to nearest health service, in minute",
                        colors: Array.from(Array(breaks.length + 1).keys()).map(cid => d3.interpolateSpectral(cFun(cid))),
                        breaksText: breaks,
                        width: 300,
                    })
                )

            } else if (serv == "educ") {
                const breaks = [2, 4, 6, 8, 10, 15, 20, 30]
                const cFun = cid => gviz.sPow(1 - cid / breaks.length, 2)
                const cHTML = c => {
                    const txt = c.avg_time_nearest_ep == "NA" ? "Unknown time" : "<b>" + c.avg_time_nearest_ep + "</b> min."
                    return txt + " to nearest primary education service<br><b>" + c.TOT_P + "</b> person" + (+c.TOT_P == 1 ? "" : "s")
                }

                app.addLayerFromDataset(
                    ds,
                    [
                        new gviz.SquareColorWGLStyle({
                            colorCol: "avg_time_nearest_ep",
                            color: d3.interpolateSpectral,
                            tFun: v => v == "NA" ? undefined : cFun(gviz.getClass(v, breaks))
                        }),
                        strokeStyle,
                    ],
                    {
                        pixNb: 1.5,
                        cellInfoHTML: cHTML,
                    }
                )
                app.addLayerFromDataset(
                    ds, [popStyle],
                    {
                        pixNb: 1.5,
                        maxZoom: 300,
                        cellInfoHTML: cHTML,
                    }
                )

                //legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorDiscreteLegend({
                        title: "Travel time to nearest primary education service, in minute",
                        colors: Array.from(Array(breaks.length + 1).keys()).map(cid => d3.interpolateSpectral(cFun(cid))),
                        breaksText: breaks,
                        width: 300,
                    })
                )
            }

            //redraw
            app.cg.redraw();
        }

        //
        document.querySelector('#health').addEventListener('change', update)
        document.querySelector('#educ').addEventListener('change', update)

        //initialise
        update()

    </script>

</body>

</html>