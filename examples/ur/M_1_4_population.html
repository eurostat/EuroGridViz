<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="font-family: sans-serif;">
    <h1>Map 1.4 - Population</h1>

    <p>
        Map showing the European population distribution at 1km resolution.
    </p>

    <div id="vizPop" style="position:relative; height:600px; width:900px;">

        <div
            style="font-size: 0.9em; position: absolute; left: 10px; top: 10px; width: auto; height: auto; padding: 5px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 3px 3px 3px grey">
            Year: <select id="year">
                <option value="2018" selected>2018</option>
                <option value="2011">2011</option>
                <option value="2006">2006</option>
            </select>
            <br>
            <input type="radio" name="style" id="color" value="color" checked>
            <label for="color">Color</label>
            <br>
            <input type="radio" name="style" id="pillar" value="pillar">
            <label for="pillar">3D bars</label>
            <br>
            <input type="radio" name="style" id="joyplot" value="joyplot">
            <label for="joyplot">Joyplot</label>
        </div>

        <div
            style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
            <span style="font-size: 0.8em; font-family: sans-serif;"><a href="https://github.com/eurostat/gridviz"
                    style="text-decoration:none">GridViz</a> |
                © <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
        </div>
    </div>
    <div id="legendPop"></div>
    <div>
        Administrative boundaries: ©EuroGeographics ©UN-FAO ©Turkstat
        <br>
        The designations employed and the presentation of material on this map do not imply the expression of any
        opinion whatsoever on the part of the European Union concerning the legal status of any country, territory, city
        or area or of its authorities, or concerning the delimitation of its frontiers or boundaries.
    </div>

    <script src="../../build/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script>

        let containerDiv = document.getElementById("vizPop");
        const app = new gviz.App(containerDiv, { legendDivId: "legendPop" })
            .setGeoCenter({ x: 4313947, y: 2970049 }).setZoomFactor(2500).setZoomFactorExtent([40, 7500])
            .setLabelLayer(gviz.getEuronymeLabelLayer()).setBoundaryLayer(gviz.getEurostatBoundariesLayer())
            .addBackgroundLayer({
                url: "https://gisco-services.ec.europa.eu/maps/tiles/GreyEarth/EPSG3035/",
                resolutions: [156543.03392804097, 78271.51696402048, 39135.75848201024, 19567.87924100512, 9783.93962050256, 4891.96981025128, 2445.98490512564],
                origin: [0, 6000000],
                filterColor: zf => "#ffffffd3",
            })


        const popDataset = app.makeMultiScaleTiledCSVGridDataset(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            r => "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/grid_pop_tiled/" + Math.round(r / 1000) + "km/",
            //r => "https://ec.europa.eu/assets/estat/E/E4/gisco/mapping/test/" + Math.round(r / 1000) + "km/",
        )

        //default color
        const col = "#e54f37"

        //
        const update = () => {

            //get year selection
            const year = document.querySelector('#year').value

            //get style selection
            const style = document.querySelector('input[name="style"]:checked').value

            //remove layers
            app.layers = []

            if (style == "color") {
                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.SquareColorWGLStyle({
                            colorCol: year,
                            color: d3.interpolateOrRd,
                            stretching: { fun: "expRev", alpha: -7 }
                        }),
                        new gviz.StrokeStyle({ strokeColorCol: year, strokeColor: v => +v ? "#666" : "", maxZoom: 80 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => +c[year] ? "<b>" + c[year] + "</b> inhabitant" + (+c[year] == 1 ? "" : "s") : undefined
                    })

                //add legend
                app.layers[0].styles[0].legends.push(new gviz.ColorLegend({
                    title: "Number of inhabitants",
                    width: 600,
                    ticks: 7,
                    colorRamp: d3.interpolateOrRd,
                    fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                }))

            } else if (style == "pillar") {

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.PillarStyle({
                            heightCol: year,
                            //height: (v, r, s, z) => 15 * r * gviz.sPow(v / s.max, 0.7),
                            height: (v, r, s, z) => 10 * r * gviz.sExpRev(v / s.max, -5),
                            color: () => col + "aa",
                            simple: true,
                            viewHeightFactor: 1,
                        })
                    ],
                    {
                        pixNb: 6,
                        cellInfoHTML: c => +c[year] ? "<b>" + c[year] + "</b> inhabitant" + (+c[year] == 1 ? "" : "s") : undefined
                    })

            } else if (style == "joyplot") {

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.JoyPlotStyle({
                            heightCol: year,
                            height: (v, r, s, zf) => 5 * r * Math.sqrt(v / s.max),
                            fillColor: () => col + "bb"
                        })
                    ],
                    {
                        pixNb: 5,
                        cellInfoHTML: c => +c[year] ? "<b>" + c[year] + "</b> inhabitant" + (+c[year] == 1 ? "" : "s") : undefined
                    })
            }

            //redraw
            app.cg.redraw();
        }

        //
        document.querySelector('#year').addEventListener('change', update)
        document.querySelector('#color').addEventListener('change', update)
        document.querySelector('#pillar').addEventListener('change', update)
        document.querySelector('#joyplot').addEventListener('change', update)

        //initialise
        update()

    </script>

</body>

</html>