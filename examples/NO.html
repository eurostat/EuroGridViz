<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title>Gridviz - example</title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <div style="
        position: absolute;
        left: 20px;
        top: 20px;
        width: auto;
        height: auto;
        padding: 10px;
        border: 0px;
        border-radius: 5px;
        background: #ffffffcc;
        line-height: 1.6;
        box-shadow: 5px 5px 5px grey;
    ">
        <div id="layer">
            <span style="font-size: 1.5em; font-weight: bold">Population</span>
            <br />
            <span style="font-size: 1.2em">
                <input type="radio" name="layer" id="pop" value="pop" checked />
                <label for="pop">Total population</label>
                <br />
                <input type="radio" name="layer" id="popTS" value="popTS" />
                <label for="popTS">Population time series</label>
                <br />
            </span>
        </div>
        <span style="font-size: 1.2em">
            <hr />
            <input type="checkbox" id="label" checked />
            <label for="label">City names</label>
            <hr />
            Source:
            <a href="https://www.ssb.no/natur-og-miljo/areal/artikler/kart-og-geodata-fra-ssb"
                style="text-decoration: none">Statistisk sentralbyrå, Statistics Norway</a>
        </span>
    </div>

    <script src="../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script>

        //UTM zone 33 with datum WGS 84
        //https://spatialreference.org/ref/epsg/32633/html/
        const proj = d3.geoTransverseMercator()
            .rotate([-15, 0])
            //.reflectX(false)
            .reflectY(true)
            .scale(6378137)//0.9996
            .translate([2500000, -27000])

        //define app
        let containerDiv = document.getElementById('viz-container')
        const app = new gviz.App(containerDiv)
            .setGeoCenter({ x: 2179500, y: 6783250 })
            .setZoomFactor(500)
            .setLabelLayer(gviz.getEuronymeLabelLayer('NO', '20', {
                proj: proj
            }))
        //.setBoundaryLayer(gviz.getEurostatBoundariesLayer())
        //TODO add boundaries with projection


        //prepare datasets, indexed by thematic domain and year
        const ds = {};
        const baseURL = 'https://raw.githubusercontent.com/jgaffuri/tiled-grid-norway/main/out/';

        const makeDataset = (code, preprocess) => {
            return app.makeMultiScaleTiledGridDataset(
                [250, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) => baseURL + code + 'csv/' + r + 'm/',
                { preprocess: preprocess }
            )
        }

        //population datasets, by year
        for (let y = 2001; y <= 2022; y++)
            ds["pop" + y] = makeDataset("pop" + y)

        //population timeseries
        ds.popTS = makeDataset("popTS")

        //TODO style per gender, age. x,y,p,m,f,ta

        //
        const update = () => {
            //read GUI selection
            const layCode = document.querySelector('input[name="layer"]:checked').value

            //remove layers
            app.layers = []

            //formater
            //const f1 = d3.format('.1f')

            //set layer
            if (layCode === 'pop') {

                const y = 2019

                app.addLayerFromDataset(
                    ds["pop" + y],
                    [
                        new gviz.SquareColorWGLStyle({
                            colorCol: 'p',
                            color: d3.interpolateYlOrRd,
                            stretching: { fun: 'expRev', alpha: -7 },
                            //set alpha and blend operation
                            //alpha: (zf) => zf < 70 ? 0.75 : 1.0,
                            //blendOperation: (zf) => zf < 10 ? "multiply" : "normal"
                        }),
                        new gviz.StrokeStyle({ maxZoom: 7 }),
                    ],
                    {
                        pixNb: 1.5,
                        cellInfoHTML: (c) => '<b>' + c.p + '</b> person' + (+c.p == 1 ? '' : 's')
                    }
                )
                //legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Population",
                        colorRamp: d3.interpolateYlOrRd,
                        fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                    })
                )

            } else if (layCode === 'popTS') {

                const ts = []; for (let i = 2002; i <= 2022; i++) ts.push("y" + i)

                app.addLayerFromDataset(
                    ds.popTS,
                    [
                        new gviz.TimeSeriesStyle({
                            ts: ts,
                            color: () => "black",
                            lineWidthCol: "y2018",
                            lineWidth: (v, r, s, z) => { return (1 + gviz.sPow(v / s.max, 0.4) * 4) * z },
                            //offsetX: (c, r, z) => r / 2,
                            //offsetY: (c, r, z) => r / 2,
                            //width: (c, r, z) => 1.5*r,
                            //height: (c, r, z) => 2*r,
                            //anchorModeY: (c, r, z) => "first"
                        })],
                    {
                        pixNb: 10,
                        //cellInfoHTML: (c) => '<b>' + c["0"] + '</b> person' + (+c["0"] == 1 ? '' : 's')
                    }
                )

            } else console.error('Unexpected layer code: ' + layCode)

            //redraw
            app.cg.redraw()
        }



        //layer update
        document.querySelector('#layer').addEventListener('change', update)

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw()
        })

        //select layer from URL
        const ls = gviz.getParameterByName('lay')
        if (ls) {
            const b = document.querySelector('#' + ls)
            if (b) b.checked = true
        }

        //initialise
        update()

    </script>


    <div style="
position: absolute;
right: 0px;
bottom: 0px;
width: auto;
height: auto;
padding: 1px;
border: 0px;
background: #ffffffcc;
">
        <span style="font-size: 0.8em">
            <a href="https://github.com/eurostat/gridviz" style="text-decoration: none">GridViz</a> |
            ©<a href="https://eurogeographics.org" style="text-decoration: none">EuroGeographics</a></span>
    </div>


</body>

</html>