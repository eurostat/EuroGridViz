<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <div id="vizPop" style="position:relative; height:700px; width:1200px;">

        <div
            style="font-size: 0.9em; position: absolute; left: 10px; top: 10px; width: auto; height: auto; padding: 5px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 3px 3px 3px grey, -3px -3px 3px #ddd">
            <span style="font-size: 1.8em; font-weight: bold;">Population grid - Demo</span><br>
            <span style="font-size: 1.3em; font-weight: bold;">Total population</span><br>
            Year: <select id="year">
                <option value="2018" selected>2018</option>
                <option value="2011">2011</option>
            </select>
            <br>
            <input type="radio" name="style" id="color" value="color" checked>
            <label for="color">Color</label>
            <br>
            <input type="radio" name="style" id="colorDark" value="colorDark">
            <label for="colorDark">Color (dark)</label>
            <br>
            <input type="radio" name="style" id="size" value="size">
            <label for="size">Circle size</label>
            <br>
            <input type="radio" name="style" id="dots" value="dots">
            <label for="dots">Dots</label>
            <br>
            <input type="radio" name="style" id="pillar" value="pillar">
            <label for="pillar">3D bars</label>
            <br>
            <input type="radio" name="style" id="joyplot" value="joyplot">
            <label for="joyplot">Joyplot</label>
            <br>
            <input type="radio" name="style" id="tanaka" value="tanaka">
            <label for="tanaka">Tanaka, smoothed: </label><input type="range" min="0" max="20" value="10" class="slider"
                id="sigmaTK" style="width: 100px;">
            <br>
            <input type="radio" name="style" id="lego" value="lego">
            <label for="lego">Lego</label>

            <br>
            <span style="font-size: 1.3em; font-weight: bold;">Population change (2011 - 2018)</span>
            <br>
            <input type="radio" name="style" id="colorCh" value="colorCh">
            <label for="colorCh">Color</label>
            <br>
            <input type="radio" name="style" id="colorChSmTK" value="colorChSmTK">
            <label for="colorChSmTK">Tanaka, smoothed: </label><input type="range" min="0" max="20" value="10"
                class="slider" id="sigmaCCH" style="width: 100px;">
            <br>
            <input type="radio" name="style" id="sizeCh" value="sizeCh">
            <label for="sizeCh">Circle size</label>
            <br>
            <input type="radio" name="style" id="segmentCh" value="segmentCh">
            <label for="segmentCh">Segment</label>

            <hr>
            <input type="checkbox" id="label" checked>
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked>
            <label for="boundary">Boundaries</label>
        </div>

        <div id="legendPop"
            style="position: absolute; right: 5px; top: 5px; width: auto; height: auto; padding: 0px; border: 0px; border-radius: 5px; background: #FFFFFFDD; line-height: 1.6; box-shadow: 5px 5px 5px grey, -3px -3px 3px #ddd">
        </div>

        <div
            style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
            <span style="font-size: 0.8em; font-family: sans-serif;"><a target="_blank"
                    rel="nofollow noreferrer noopener" href="https://github.com/eurostat/gridviz"
                    style="text-decoration:none">GridViz</a> |
                © <a target="_blank" rel="nofollow noreferrer noopener" href="https://eurogeographics.org"
                    style="text-decoration:none">EuroGeographics</a> |
                © <a target="_blank" rel="nofollow noreferrer noopener" href="https://www.tuik.gov.tr"
                    style="text-decoration:none">Turkstat</a>
            </span>
        </div>

    </div>

    <script src="../dist/gridviz.js"></script>
    <script src="https://ec.europa.eu/assets/estat/E/E4/gisco/ure2023/d3-color.js"></script>
    <script src="https://ec.europa.eu/assets/estat/E/E4/gisco/ure2023/d3-interpolate.js"></script>
    <script src="https://ec.europa.eu/assets/estat/E/E4/gisco/ure2023/d3-scale-chromatic.js"></script>
    <script>
        const nuts2jsonURL = "https://raw.githubusercontent.com/eurostat/Nuts2json/master/pub/v2/" //"https://ec.europa.eu/assets/estat/E/E4/gisco/pub/nuts2json/v2/"
        const euronymURL = "https://raw.githubusercontent.com/eurostat/euronym/main/pub/v2/UTF/" //"https://ec.europa.eu/assets/estat/E/E4/gisco/pub/euronym/v2/UTF/"
        const tiledGridsURL = "https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/" //"https://ec.europa.eu/eurostat/cache/GISCO/urbanrural/grid_data/europe/"
        const bgLayerURL = "https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/" //"https://ec.europa.eu/eurostat/cache/GISCO/urbanrural/background/elevation_shading/"
        const boundaryColor = "#888";

        let containerDiv = document.getElementById("vizPop");
        const app = new gviz.App(containerDiv, { legendDivId: "legendPop" })
            .setGeoCenter({ x: 4313947, y: 2970049 }).setZoomFactor(600).setZoomFactorExtent([40, 7500])
            .setLabelLayer(
                gviz.getEuronymeLabelLayer("EUR", 50, {
                    ccIn: ["AT", "BE", "BG", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GR", "HR", "HU", "IE", "IT", "LT", "LU", "LV", "PL", "PT", "MT", "NL", "RO", "SE", "SK", "SI", "CH", "IS", "NO", "LI", "RS", "XK", "AL", "TR", "ME", "MK"],
                    baseURL: euronymURL,
                })
            )
            .setBoundaryLayer(gviz.getEurostatBoundariesLayer({
                baseURL: nuts2jsonURL,
                showOth: false,
                color: (f, zf) => {
                    const p = f.properties
                    if (p.id >= 100000) return "#bcbcbc"
                    if (p.co === "T") return "#888"
                    if (zf < 400) return "#888"
                    else if (zf < 1000) return p.lvl >= 3 ? "" : "#888"
                    else if (zf < 2000) return p.lvl >= 2 ? "" : "#888"
                    else return p.lvl >= 1 ? "" : "#888"
                },
            }))
            .addBackgroundLayer({
                url: bgLayerURL,
                resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
                origin: [0, 6000000],
                filterColor: zf => "#ffffffc0",
            })


        //load dataset
        const popDataset = app.makeMultiScaleTiledGridDataset(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            r => tiledGridsURL + "population/" + r + "m/",
            {
                preprocess: (c) => {
                    //console.log(c)
                    if (c.CNTR_ID == "UK") return false
                    if (c.CNTR_ID == "0-UK") return false
                    //if (c.CNTR_ID == "BA") return false
                    if (c.CNTR_ID == "IM") return false
                    //console.log(c.CNTR_ID)
                    delete c.CNTR_ID

                    //prepare 2011 -> 2018 change data
                    if (!c["2011"] && !c["2018"]) c.d2011_2018 = 0
                    else if (!c["2011"] && c["2018"]) c.d2011_2018 = + c["2018"]
                    else if (c["2011"] && !c["2018"]) c.d2011_2018 = - c["2011"]
                    else c.d2011_2018 = c["2018"] - c["2011"]
                    //ratio
                    c.p2011_2018 = c["2011"] == 0 ? 999 : c.d2011_2018 / c["2011"]
                }
            }
        )

        //default color
        const col = "#e54f37"

        //
        const update = () => {

            //get year selection
            const year = document.querySelector('#year').value

            //get style selection
            const style = document.querySelector('input[name="style"]:checked').value

            //remove layers
            app.layers = []

            //tooltip functions
            const tooltipFun = (c, r) =>
                +c[year] ? "<b>" + c[year] + "</b> inhabitant" + (+c[year] == 1 ? "" : "s") + " per " + (r * r / 1000000) + "km²" : undefined
            const tooltipFunCh = c => (
                "2011: " + c["2011"] + "<br>2018: " + c["2018"]
            )
                + "<br>"
                + "<b>" + (c["d2011_2018"] == 0 ? "No change" : (c["d2011_2018"] > 0 ? "+" : "") + c["d2011_2018"] + " inhabitants") + "</b>"

            //set default background filter color
            app.bgLayers[0].filterColor = zf => "#ffffffc0"

            if (style == "color") {
                const colR = d3.interpolateOrRd

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.SquareColorWGLStyle({
                            colorCol: year,
                            color: colR,
                            stretching: { fun: "expRev", alpha: -7 }
                        }),
                        new gviz.StrokeStyle({ strokeColorCol: year, strokeColor: v => +v ? "#666" : "", maxZoom: 80 })
                    ],
                    {
                        pixNb: 1.8,
                        cellInfoHTML: tooltipFun
                    })

                //add legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Number of inhabitants",
                        width: 400,
                        ticks: 5,
                        colorRamp: colR,
                        fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                    })
                )

            } else if (style == "colorDark") {
                const colR = d3.interpolateMagma

                //set dark background filter color
                app.bgLayers[0].filterColor = zf => "#000000c0"

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.SquareColorWGLStyle({
                            colorCol: year,
                            color: colR,
                            stretching: { fun: "expRev", alpha: -7 }
                        }),
                        new gviz.StrokeStyle({ strokeColorCol: year, strokeColor: v => +v ? "#999" : "", maxZoom: 80 })
                    ],
                    {
                        pixNb: 1.8,
                        cellInfoHTML: tooltipFun
                    })

                //add legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Number of inhabitants",
                        width: 400,
                        ticks: 5,
                        colorRamp: colR,
                        fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                    })
                )

            } else if (style == "size") {

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.ShapeColorSizeStyle({
                            color: () => col + "bb",
                            sizeCol: year,
                            size: (v, r, s, zf) => 1.5 * r * gviz.sPow(v / s.max, 0.3),
                            shape: () => "circle",
                        })
                    ],
                    {
                        pixNb: 7,
                        cellInfoHTML: tooltipFun
                    })

                //add legend
                app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ title: "Number of inhabitants", exaggerationFactor: 0.8, shape: "circle", fillColor: col }).style("padding", "0px 5px"))
                app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ exaggerationFactor: 0.25, shape: "circle", fillColor: col }).style("padding", "0px 5px"))
                app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ exaggerationFactor: 0.02, shape: "circle", fillColor: col }).style("padding", "0px 5px"))

            } else if (style == "dots") {

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.DotDensityStyle({
                            nbCol: year,
                            nb: (v, r, s, zf) => 10 * r * r / (zf * zf) * v / s.max,
                            dotSize: (r, zf) => 1.2 * zf,
                            color: () => col
                        })
                    ],
                    {
                        pixNb: 5,
                        cellInfoHTML: tooltipFun
                    })


            } else if (style == "pillar") {

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.PillarStyle({
                            heightCol: year,
                            //height: (v, r, s, z) => 15 * r * gviz.sPow(v / s.max, 0.7),
                            height: (v, r, s, z) => 10 * r * gviz.sExpRev(v / s.max, -5),
                            color: () => col + "aa",
                            simple: true,
                            viewHeightFactor: 1,
                        })
                    ],
                    {
                        pixNb: 6,
                        cellInfoHTML: tooltipFun
                    })

            } else if (style == "joyplot") {

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.JoyPlotStyle({
                            heightCol: year,
                            height: (v, r, s, zf) => 5 * r * Math.sqrt(v / s.max),
                            fillColor: () => col + "bb"
                        })
                    ],
                    {
                        pixNb: 5,
                        cellInfoHTML: tooltipFun
                    })


            } else if (style == "tanaka") {

                //get year selection
                const sigma = document.querySelector('#sigmaTK').value

                const nb = 10
                const colR = d3.interpolateOrRd

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.KernelSmoothingStyle({
                            value: c => +c[year],
                            sigma: (r, zf) => r * sigma / 10,
                            styles: gviz.TanakaStyle.get(
                                "ksmval",
                                {
                                    tFun: (v, r, s, zf) => v == 0 ? 0 : gviz.sExpRev((v - s.min) / (s.max - s.min), -7), color: colR,
                                    nb: nb,
                                    //newShading: true,
                                }),
                        })
                    ],
                    {
                        pixNb: 4,
                        cellInfoHTML: tooltipFun
                    })

                //legend
                app.layers[0].styles[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Number of inhabitants",
                        colorRamp: t => colR(Math.floor(t * nb) / nb),
                        //width: 500,
                        //ticks: 6,
                        //fun: (t, r, s) => s.min + (s.max - s.min) * gviz.sExpRevInverse(t, -7),
                        width: 200,
                        ticks: 2,
                        tickFormat: "text",
                        fun: (t, r, s) => t == 0 ? "Low" : t == 1 ? "High" : "X",
                    })
                )

            } else if (style == "lego") {
                //const colR = d3.interpolateCubehelixDefault //interpolateOrRd
                //const nb = 12
                const sigmaFun = (r, zf) => r * 0.5

                //const cols = []
                //for (let t = 0; t < 1; t += 1 / nb) cols.push(colR(t))

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.KernelSmoothingStyle({
                            value: c => +c[year],
                            sigma: sigmaFun,
                            styles: gviz.LegoStyle.get("ksmval", {
                                tFun: (v, r, s, zf) => v == 0 ? 0 : gviz.sExpRev((v - s.min) / (s.max - s.min), -7),
                                //colors: cols
                            })
                        })
                    ],
                    {
                        pixNb: 8,
                        cellInfoHTML: tooltipFun
                    })


                //legend
                const colsLego = ["#00852b", "#afd246", "#fac80a", "#bb805a", "#d67923", "#cb4e29", "#b40000", "#720012"]
                app.layers[0].styles[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Number of inhabitants",
                        colorRamp: t => colsLego[t == 1 ? 7 : Math.floor(t * 8)], //colR(Math.floor(t * nb) / nb),
                        width: 200,
                        ticks: 2,
                        tickFormat: "text",
                        fun: (t, r, s) => t == 0 ? "Low" : t == 1 ? "High" : "X",
                    })
                )

            } else if (style == "colorCh") {
                const streC = 0.22

                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.ShapeColorSizeStyle({
                            colorCol: "d2011_2018",
                            color: (v, r, s) => {
                                const stre = gviz.sPow
                                let t = 0.5
                                if (s.min < 0 && v < 0) {
                                    t -= stre(v / s.min, streC) / 2
                                } else {
                                    t += stre(v / s.max, streC) / 2
                                }
                                t = 1 - t;
                                return d3.interpolateSpectral(t);
                            },
                            shape: () => "square",
                        }),
                        new gviz.StrokeStyle({ maxZoom: 80 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: tooltipFunCh
                    }
                )

                //legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Population change (number of inhabitants)",
                        ticks: 7,
                        width: 500,
                        colorRamp: d3.interpolateSpectral,
                        invert: true,
                        fun: (t, r, s) => {
                            const streI = gviz.sPowInverse
                            if (t < 0.5)
                                return s.min * streI(1 - 2 * t, streC)
                            if (t > 0.5)
                                return s.max * streI(2 * t - 1, streC)
                            return 0
                        }
                    })
                )


            } else if (style == "colorChSmTK") {
                const colR = d3.interpolateSpectral
                const nb = 15
                const stre = gviz.sPow
                const streC = 0.3

                //get year selection
                const sigma = document.querySelector('#sigmaCCH').value

                //add layer
                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.KernelSmoothingStyle({
                            value: c => +c["d2011_2018"],
                            sigma: (r, zf) => r * sigma / 10,
                            styles:
                                gviz.TanakaStyle.get("ksmval", {
                                    tFun: (v, r, s, zf) => {
                                        let t = 0.5
                                        if (s.min < 0 && v < 0) {
                                            t += stre(v / s.min, streC) / 2
                                        } else {
                                            t -= stre(v / s.max, streC) / 2
                                        }
                                        t = 1 - t;
                                        t = Math.floor(t * nb) / nb
                                        return t;
                                    },
                                    color: (t) => colR(1 - t),
                                    nb: nb,
                                    //newShading: true,
                                }),
                        }),
                    ],
                    {
                        pixNb: 4,
                        cellInfoHTML: tooltipFunCh
                    })


                //legend
                app.layers[0].styles[0].styles[0].legends.push(new gviz.ColorLegend({
                    title: "Population change",
                    width: 200,
                    ticks: 3,
                    colorRamp: t => colR(1 - Math.floor(t * nb) / nb),
                    tickFormat: "text",
                    fun: (t, r, s) => t == 0 ? "Decrease" : t == 1 ? "Increase" : "Stable",
                }))


            } else if (style == "sizeCh") {

                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.ShapeColorSizeStyle({
                            colorCol: "d2011_2018",
                            color: (v) => v > 0 ? "#d13c4bcc" : "#4288b5cc",
                            sizeCol: "d2011_2018",
                            size: (v, r, s, zf) => {
                                const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                                return 1.5 * r * gviz.sPow(Math.abs(v) / max, 0.2)
                            },
                            shape: () => "circle",
                        })
                    ],
                    {
                        pixNb: 7,
                        cellInfoHTML: tooltipFunCh
                    }
                )

                //legend
                app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ title: "Population change", exaggerationFactor: 0.9, shape: "circle", labelUnitText: "inhabitants", fillColor: "gray" }).style("padding", "0px 5px"))
                app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ exaggerationFactor: 0.2, shape: "circle", labelUnitText: "", fillColor: "gray" }).style("padding", "0px 5px"))
                app.layers[0].styles[0].legends.push(new gviz.SizeLegend({ exaggerationFactor: 0.01, shape: "circle", labelUnitText: "", fillColor: "gray" }).style("padding", "0px 5px"))
                const lgCat = new gviz.ColorCategoryLegend({ shape: "square", colCat: [["#d13c4b", "Increase"], ["#4288b5", "Decrease"]] })
                app.layers[0].styles[0].legends.push(lgCat)

            } else if (style == "segmentCh") {
                const maxAngle = 60

                app.addLayerFromDataset(
                    popDataset,
                    [
                        new gviz.SegmentStyle({
                            orientation: (c) => {
                                let a = c.p2011_2018 * maxAngle / 0.3
                                a = a < -maxAngle ? -maxAngle : a > maxAngle ? maxAngle : a;
                                return a
                            },
                            colorCol: "p2011_2018",
                            color: (v) => Math.abs(v) < 0.02 ? "gray" : v > 0 ? "#d13c4bcc" : "#4288b5cc",
                            length: (v, r) => r,
                            //lengthCol: "2011",
                            //length: (v, r, s, zf) => r * gviz.sPow(v / s.max, 0.25),
                            widthCol: "2018",
                            width: (v, r, s, zf) => 0.8 * r * gviz.sPow(v / s.max, 0.25)
                        })],
                    {
                        pixNb: 10,
                        cellInfoHTML: tooltipFunCh
                    }
                )

                //legend

                app.layers[0].styles[0].legends.push(new gviz.SegmentWidthLegend({
                    title: "Population in 2018",
                    labelUnitText: "inhab."
                }))

                app.layers[0].styles[0].legends.push(new gviz.SegmentOrientationLegend({
                    title: "Population change",
                    labelUnitText: "Strong increase",
                    color: "#d13c4b",
                    orientation: 60
                }))
                app.layers[0].styles[0].legends.push(new gviz.SegmentOrientationLegend({
                    labelUnitText: "Weak increase",
                    color: "#d13c4b",
                    orientation: 30
                }))
                app.layers[0].styles[0].legends.push(new gviz.SegmentOrientationLegend({
                    labelUnitText: "Stability (<1%)",
                    color: "gray",
                    orientation: 0
                }))
                app.layers[0].styles[0].legends.push(new gviz.SegmentOrientationLegend({
                    labelUnitText: "Weak decrease",
                    color: "#4288b5",
                    orientation: -30
                }))
                app.layers[0].styles[0].legends.push(new gviz.SegmentOrientationLegend({
                    labelUnitText: "Strong decrease",
                    color: "#4288b5",
                    orientation: -60
                }))
                //const lgCat = new gviz.ColorCategoryLegend({ title: "Population change", shape: "square", colCat: [["#d13c4b", "Increase"], ["gray", "Stable (<1%)"], ["#4288b5", "Decrease"]] })
                //app.layers[0].styles[0].legends.push(lgCat)

            }

            //redraw
            app.cg.redraw();
        }

        //
        document.querySelector('#year').addEventListener('change', update)
        document.querySelector('#color').addEventListener('change', update)
        document.querySelector('#colorDark').addEventListener('change', update)
        document.querySelector('#pillar').addEventListener('change', update)
        document.querySelector('#joyplot').addEventListener('change', update)
        document.querySelector('#size').addEventListener('change', update)
        document.querySelector('#dots').addEventListener('change', update)
        document.querySelector('#tanaka').addEventListener('change', update)
        document.querySelector('#lego').addEventListener('change', update)
        document.querySelector('#colorCh').addEventListener('change', update)
        document.querySelector('#colorChSmTK').addEventListener('change', update)
        document.querySelector('#sizeCh').addEventListener('change', update)
        document.querySelector('#segmentCh').addEventListener('change', update)

        //sigma selection
        document.getElementById('sigmaTK').oninput = update
        document.getElementById('sigmaCCH').oninput = update

        //zoom
        //document.querySelector('#zoomin').addEventListener('click', () => app.setZoomFactor(app.getZoomFactor() * 0.8).redraw())
        //document.querySelector('#zoomout').addEventListener('click', () => app.setZoomFactor(app.getZoomFactor() * 1.2).redraw())

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw();
        });

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            app.showBoundaries = this.checked
            app.cg.redraw();
        });

        //initialise
        update()

    </script>

</body>

</html>