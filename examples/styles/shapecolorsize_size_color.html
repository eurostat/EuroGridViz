<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title>Gridviz - Shape/color/size style</title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <div style="
                position: absolute;
                left: 20px;
                top: 20px;
                width: auto;
                height: auto;
                padding: 10px;
                border: 0px;
                border-radius: 5px;
                background: #ffffffcc;
                line-height: 1.6;
                box-shadow: 5px 5px 5px grey;
            ">
        <select id="shape" style="font-size: 1.5em">
            <option value="circle" selected>Circle</option>
            <option value="square">Square</option>
            <option value="diamond">Diamond</option>
            <option value="donut">Donut</option>
        </select>
    </div>

    <script src="../../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script>
        let containerDiv = document.getElementById('viz-container')

        const map = new gviz.Map(containerDiv)
            .setGeoCenter({ x: 3763437, y: 2891045 })
            .setZoom(50.1)
            .setZoomExtent([7, 2000])
            .addMultiScaleTiledGridLayer(
                [200, 400, 600, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiled-grid-france-filosofi/main/out/csv/met/inc/2019/' +
                    r +
                    'm/',
                [
                    new gviz.ShapeColorSizeStyle({
                        color: (c, r, zf, viewScale) => {
                            let t = (c.revind - 1200) / (3700 - 1200)
                            t = t > 1 ? 1 : t < 0 ? 0 : t
                            return d3.interpolateSpectral(1 - t)
                        },
                        size: (c, r, zf, viewScale) => 1.41 * viewScale(c.ind),
                        viewScale: gviz.sizeContinuousScale({ valueFunction: (c) => +c.ind, stretching: gviz.powerScale(0.13) }),
                        shape: () => "circle"
                    }),
                ],
                {
                    minPixelsPerCell: 6,
                    preprocess: (c) => {
                        c.revind = Math.round(c.ind_snv / c.ind / 12)
                    },
                }
            )

        //shape selection
        const s = map.layers[0].styles[0]
        document.getElementById('shape').addEventListener('change', function () {
            const v_ = this.value

            //set shape
            s.shape = () => v_

            //set size
            const sizeFactor = (v_ === 'circle' || v_ === 'diamond') ? 1.41 : 1
            s.size = (c, r, zf, viewScale) => sizeFactor * viewScale(c.ind)
            //redraw
            map.cg.redraw()
        })
    </script>
</body>

</html>