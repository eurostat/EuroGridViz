<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title>Gridviz - Kernel smoothing style</title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <div id="viz-container" style="height:100%; width:100%;"></div>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <select id="style" style="font-size: 1em">
            <option value="color" selected>Color</option>
            <option value="size">size</option>
            <option value="joyplot">Joy plot</option>
            <option value="tanaka">Tanaka</option>
        </select>
        <br>
        <input type="range" min="1" max="16" value="8" class="slider" id="sigma">
    </div>

    <script src="../../build/gridviz.js"></script>
    <script>

        let containerDiv = document.getElementById("viz-container");
        const app = new gviz.App(containerDiv)
            .setGeoCenter({ x: 4000000, y: 2960000 }).setZoomFactor(1000)

        //style examples
        const styles = {
            color: [
                new gviz.SquareColorWGLStyle({
                    colorCol: "ksmval",
                    color: gviz.interpolateRdYlGn,
                    tFun: (v, r, s) => {
                        const v_ = gviz.sExp((v) / s.max, -20)
                        const nbClass = 10
                        const cl = Math.floor(nbClass * v_) / nbClass
                        if (cl < 1 / nbClass) return "white"
                        return 1 - cl
                    }
                })
            ],
            joyplot: [new gviz.JoyPlotStyle({
                heightCol: "ksmval",
                height: (v, r, s, zf) => 5 * r * Math.sqrt(v / s.max),
            })],
            size: [new gviz.ShapeColorSizeStyle({
                color: () => "gray",
                sizeCol: "ksmval",
                size: (v, r, s, zf) => 1.3 * r * Math.pow(v / s.max, 0.3),
                shape: () => "circle",
            })],
            tanaka: gviz.TanakaStyle.get("ksmval", { tFun: (v, r, s, zf) => gviz.sExp((v - s.min) / (s.max - s.min), -50) }),
        }

        //define kernel smoothing filter
        const s = new gviz.KernelSmoothingStyle({
            value: c => +c["2018"],
            sigma: (r, zf) => zf * 8,
            styles: styles.color
        });

        //add layer
        app.addMultiScaleTiledCSVGridLayer(
            [1000, 2000, 5000, 10000, 20000, 50000, 100000],
            r => "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/grid_pop_tiled/" + Math.round(r / 1000) + "km/",
            [s],
            {
                pixNb: 5,
                cellInfoHTML: c => "<b>" + c["2018"] + "</b> inhabitant(s)"
            }
        )



        //style selection
        const select = document.getElementById('style');
        select.addEventListener('change', function () {
            //set selected style
            s.styles = styles[this.value]
            //redraw
            app.cg.redraw()
        });

        //sigma selection
        document.getElementById('sigma').oninput = function () {
            //set sigma
            s.sigma = (r, zf) => zf * (+this.value)
            //redraw
            app.cg.redraw()
        }
    </script>

</body>

</html>