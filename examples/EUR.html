<!DOCTYPE html>
<html lang="en" style="height: 100%">
    <head>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />

        <title></title>
    </head>

    <body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
        <div id="viz-container" style="height: 100%; width: 100%"></div>

        <div
            style="
                position: absolute;
                left: 20px;
                top: 20px;
                width: auto;
                height: auto;
                padding: 10px;
                border: 0px;
                border-radius: 5px;
                background: #ffffffcc;
                line-height: 1.6;
                box-shadow: 5px 5px 5px grey;
            "
        >
            <span style="font-size: 1em">
                <span style="font-size: 1.5em; font-weight: bold">Europe grid</span><br />
                <hr />
                <div id="layer">
                    <span style="font-weight: bold">Population</span>
                    <br />
                    <input type="radio" name="layer" id="y2018" value="y2018" checked />
                    <label for="y2018">2018</label>
                    <input type="radio" name="layer" id="y2011" value="y2011" />
                    <label for="y2011">2011</label>
                    <input type="radio" name="layer" id="y2006" value="y2006" />
                    <label for="y2006">2006</label>
                    <br />
                    <input type="radio" name="layer" id="popChange" value="popChange" />
                    <label for="popChange">Change from </label>
                    <select id="pcyIni" disabled>
                        <option value="2006" selected>2006</option>
                        <option value="2011">2011</option>
                        <option value="2018">2018</option>
                    </select>
                    to
                    <select id="pcyFin" disabled>
                        <option value="2006">2006</option>
                        <option value="2011">2011</option>
                        <option value="2018" selected>2018</option>
                    </select>
                    <br />
                    <input type="radio" name="layer" id="degurba" value="degurba" />
                    <label for="degurba">Degree of urbanisation</label>
                    <br />
                    <span style="font-weight: bold">Accessibility</span>
                    <br />
                    <input type="radio" name="layer" id="rtp" value="rtp" />
                    <label for="rtp">Road transport performance</label>
                    <br />
                    <input type="radio" name="layer" id="accHealth" value="accHealth" />
                    <label for="accHealth">Healthcare services</label>
                    <br />
                    <input type="radio" name="layer" id="accEducPrim" value="accEducPrim" />
                    <label for="accEducPrim">Primary schools</label>
                </div>

                <hr />
                <input type="checkbox" id="label" checked />
                <label for="label">City names</label>
                <input type="checkbox" id="boundary" checked />
                <label for="boundary">Boundaries</label>
                <hr />
                Source:
                <a
                    href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/grids"
                    target="_blank"
                    rel="noopener noreferrer"
                    >European Commission</a
                >
            </span>
        </div>

        <script src="../dist/gridviz.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
        <script>
            let containerDiv = document.getElementById('viz-container')
            const app = new gviz.App(containerDiv)
                .setGeoCenter({ x: 4313947, y: 2970049 })
                .setZoomFactor(600)
                .setZoomFactorExtent([40, 7500])
                .setLabelLayer(gviz.getEuronymeLabelLayer())
                .setBoundaryLayer(gviz.getEurostatBoundariesLayer())
                //.setBackgroundColor("#d3eeff")
                .setViewFromURL()
                .addBackgroundLayer({
                    //url: "https://gisco-services.ec.europa.eu/maps/tiles/GreyEarth/EPSG3035/",
                    //resolutions: [156543.03392804097, 78271.51696402048, 39135.75848201024, 19567.87924100512, 9783.93962050256, 4891.96981025128, 2445.98490512564],
                    //origin: [0, 6000000],
                    //filterColor: zf => "#ffffffd3",
                    url: 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/',
                    resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
                    origin: [0, 6000000],
                    filterColor: (zf) => '#ffffffc0',
                })

            //prepare datasets
            const ds = {}

            //population dataset
            ds.pop = app.makeMultiScaleTiledGridDataset(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/population/' +
                    r +
                    'm/',
                {
                    preprocess: (c) => {
                        //prepare 2011 -> 2018 change data
                        if (!c['2011'] && !c['2018']) c.d2011_2018 = 0
                        else if (!c['2011'] && c['2018']) c.d2011_2018 = +c['2018']
                        else if (c['2011'] && !c['2018']) c.d2011_2018 = -c['2011']
                        else c.d2011_2018 = c['2018'] - c['2011']

                        //prepare 2006 -> 2011 change data
                        if (!c['2006'] && !c['2011']) c.d2006_2011 = 0
                        else if (!c['2006'] && c['2011']) c.d2006_2011 = +c['2011']
                        else if (c['2006'] && !c['2011']) c.d2006_2011 = -c['2006']
                        else c.d2006_2011 = c['2011'] - c['2006']

                        //prepare 2006 -> 2018 change data
                        if (!c['2006'] && !c['2018']) c.d2006_2018 = 0
                        else if (!c['2006'] && c['2018']) c.d2006_2018 = +c['2018']
                        else if (c['2006'] && !c['2018']) c.d2006_2018 = -c['2006']
                        else c.d2006_2018 = c['2018'] - c['2006']
                    },
                }
            )

            //accessibility dataset
            //define class breaks
            const breaksH = [5, 10, 15, 20, 30, 45, 60, 90]
            const breaksE = [2, 4, 6, 8, 10, 15, 20, 30]
            ds.acc = app.makeMultiScaleTiledGridDataset(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/accessibility/' +
                    r +
                    'm/',
                {
                    preprocess: (c) => {
                        //filter
                        const keep = c.avg_time_nearest_h != 'NA' || c.avg_time_nearest_ep != 'NA'
                        if (!keep) return false
                        //classify
                        c.cH =
                            c.avg_time_nearest_h == 'NA' ? 'NA' : gviz.getClass(c.avg_time_nearest_h, breaksH)
                        c.cE =
                            c.avg_time_nearest_ep == 'NA'
                                ? 'NA'
                                : gviz.getClass(c.avg_time_nearest_ep, breaksE)
                    },
                }
            )

            //road transp perf dataset
            ds.rtp = app.makeMultiScaleTiledGridDataset(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/road_transp_perf/' +
                    r +
                    'm/'
            )

            //degurba dataset
            ds.degurba = app.makeMultiScaleTiledGridDataset(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiledgrids/main/data/europe/degurba/' +
                    r +
                    'm/',
                {
                    preprocess: (c) => {
                        if (+c.TOT != 1) c.c = 'zzz'
                        else
                            c.c = +c.uc
                                ? 'uc'
                                : +c.du
                                ? 'du'
                                : +c.sdu
                                ? 'sdu'
                                : +c.sbu
                                ? 'sbu'
                                : +c.r
                                ? 'r'
                                : +c.lr
                                ? 'lr'
                                : +c.vlr
                                ? 'vlr'
                                : 'NA'
                    },
                }
            )

            //
            const update = () => {
                //read GUI selection
                const layCode = document.querySelector('input[name="layer"]:checked').value

                //remove layers
                app.layers = []

                //select layer and style
                if (layCode === 'y2006' || layCode === 'y2011' || layCode === 'y2018') {
                    const layCode_ = layCode.replace('y', '')
                    app.addLayerFromDataset(
                        ds.pop,
                        [
                            new gviz.SquareColorWGLStyle({
                                colorCol: layCode_,
                                color: d3.interpolateOrRd,
                                stretching: { fun: 'expRev', alpha: -7 },
                            }),
                            new gviz.StrokeStyle({
                                strokeColorCol: layCode_,
                                strokeColor: (v) => (+v ? '#666' : ''),
                                maxZoom: 80,
                            }),
                        ],
                        {
                            pixNb: 2,
                            cellInfoHTML: (c) =>
                                +c[layCode_]
                                    ? '<b>' + c[layCode_] + '</b> inhabitant(s) in ' + layCode_
                                    : undefined,
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: 'Number of inhabitants',
                            ticks: 5,
                            colorRamp: d3.interpolateOrRd,
                            fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                        })
                    )
                } else if (layCode === 'popChange') {
                    //
                    const yIni = document.querySelector('#pcyIni').value
                    const yFin = document.querySelector('#pcyFin').value
                    if (yIni != yFin) {
                        const layCode_ = 'd' + yIni + '_' + yFin

                        app.addLayerFromDataset(
                            ds.pop,
                            [
                                new gviz.ShapeColorSizeStyle({
                                    colorCol: layCode_,
                                    color: (v, r, s) => {
                                        const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                                        const t = (Math.sign(v) * gviz.sPow(Math.abs(v) / max, 0.2)) / 2 + 0.5
                                        return d3.interpolateSpectral(1 - t)
                                    },
                                    shape: () => 'square',
                                }),
                                new gviz.StrokeStyle({ maxZoom: 80 }),
                            ],
                            {
                                pixNb: 2,
                                cellInfoHTML: (c) =>
                                    '2011: ' +
                                    c['2011'] +
                                    '<br>2018: ' +
                                    c['2018'] +
                                    '<br>' +
                                    '<b>' +
                                    (c[layCode_] == 0
                                        ? 'No change'
                                        : (c[layCode_] > 0 ? '+' : '') + c[layCode_] + ' inhabitants') +
                                    '</b>',
                            }
                        )
                        //legend
                        app.layers[0].styles[0].legends.push(
                            new gviz.ColorLegend({
                                title: 'Population change',
                                ticks: 5,
                                colorRamp: d3.interpolateSpectral,
                                invert: true,
                                fun: (t, r, s) => {
                                    const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                                    return (t < 0.5 ? -1 : 1) * max * gviz.sPow(Math.abs(2 * t - 1), 1 / 0.2)
                                },
                            })
                        )
                    }

                    //urbanisation
                } else if (layCode === 'degurba') {
                    app.addLayerFromDataset(
                        ds.pop,
                        [
                            new gviz.ShapeColorSizeStyle({
                                color: () => '#666',
                                sizeCol: '2018',
                                size: (v, r, s, zf) => 0.8 * r * gviz.sPow(v / s.max, 0.3),
                                shape: () => 'circle',
                            }),
                        ],
                        {
                            pixNb: 8,
                            maxZoom: 80,
                        }
                    )

                    const degurbaColors = {
                        uc: '#ff0202', //Cities
                        du: '#ff0202', //Cities
                        sbu: '#ffff00', //Suburbs
                        sdu: '#a87000', //Towns
                        r: '#375623', //Villages
                        lr: '#abcd66', //Dispersed rural areas
                        vlr: '#cdf57a', //Mostly uninhabited areas
                        NA: 'gray',
                    }

                    app.addLayerFromDataset(
                        ds.degurba,
                        [
                            new gviz.CompositionStyle({
                                color: degurbaColors,
                                type: () => 'flag',
                                //stripesOrientation: () => 0,
                                sizeCol: 'TOT',
                                size: (v, r, s, z) =>
                                    1 * r * gviz.sPow(v / s.max, 0.5) + (z < 500 ? 0.8 * z : 0),
                                minZoom: 80,
                            }),
                            /*new gviz.SquareColorCatWGLStyle({
                            colorCol: "c",
                            color: degurbaColors,
                            maxZoom: 400,
                            minZoom: 120,
                        }),*/
                            new gviz.SideCatStyle({
                                col: 'c',
                                color: degurbaColors,
                                width: (side, r, z) => z * 3,
                                fillColor: (c) => degurbaColors[c.c] + '55',
                                maxZoom: 80,
                            }),
                        ],
                        {
                            pixNb: 3.5,
                            cellInfoHTML: (c) => {
                                if (!c.TOT) return 'No information'
                                if (c.TOT == 1)
                                    return +c.uc
                                        ? 'City'
                                        : +c.du
                                        ? 'City'
                                        : +c.sbu
                                        ? 'Suburb'
                                        : +c.sdu
                                        ? 'Town'
                                        : +c.r
                                        ? 'Village'
                                        : +c.lr
                                        ? 'Dispersed rural'
                                        : +c.vlr
                                        ? 'Mostly uninhabited'
                                        : 'Unknown'
                                const out = []
                                //if (+c.uc) out.push(c.uc + " large city cell" + (+c.uc == 1 ? "" : "s") + "<br>")
                                if (+c.uc + +c.du)
                                    out.push(
                                        +c.uc +
                                            +c.du +
                                            ' city cell' +
                                            (+c.uc + +c.du == 1 ? '' : 's') +
                                            '<br>'
                                    )
                                if (+c.sbu)
                                    out.push(c.sbu + ' suburb cell' + (+c.sbu == 1 ? '' : 's') + '<br>')
                                if (+c.sdu) out.push(c.sdu + ' town cell' + (+c.sdu == 1 ? '' : 's') + '<br>')
                                if (+c.r) out.push(c.r + ' village cell' + (+c.r == 1 ? '' : 's') + '<br>')
                                if (+c.lr)
                                    out.push(
                                        c.lr + ' dispersed rural cell' + (+c.lr == 1 ? '' : 's') + '<br>'
                                    )
                                if (+c.vlr)
                                    out.push(
                                        c.vlr + ' mostly uninhabited cell' + (+c.vlr == 1 ? '' : 's') + '<br>'
                                    )
                                if (+c.NA) out.push(c.NA + ' unknown cell' + (+c.NA == 1 ? '' : 's') + '<br>')
                                return out.join('')
                            },
                            preprocess: (c) => {
                                if (+c.TOT != 1) c.c = 'zzz'
                                else
                                    c.c = +c.uc
                                        ? 'uc'
                                        : +c.du
                                        ? 'du'
                                        : +c.sdu
                                        ? 'sdu'
                                        : +c.sbu
                                        ? 'sbu'
                                        : +c.r
                                        ? 'r'
                                        : +c.lr
                                        ? 'lr'
                                        : +c.vlr
                                        ? 'vlr'
                                        : 'NA'
                            },
                        }
                    )

                    //population legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({ shape: 'circle', labelUnitText: 'persons', fillColor: '#666d' })
                    )

                    //degurba legend
                    const catLeg = new gviz.ColorCategoryLegend({
                        title: 'Degree of urbanisation',
                        colCat: [
                            /*["#286eb4", "City"],
                        ["#c87e04", "Suburb"],
                        ["#fcc974", "Town"],
                        ["#468631", "Village"],
                        ["#9dd58a", "Dispersed rural"],
                        ["#c2d5bc", "Mostly uninhabited"],*/
                            ['#ff0202', 'City'],
                            ['#ffff00', 'Suburb'],
                            ['#a87000', 'Town'],
                            ['#375623', 'Village'],
                            ['#abcd66', 'Dispersed rural'],
                            ['#cdf57a', 'Mostly uninhabited'],
                        ],
                        shape: 'square',
                    })
                    app.layers[1].styles[0].legends.push(catLeg)
                    app.layers[1].styles[1].legends.push(catLeg)

                    //road transport performence
                } else if (layCode === 'rtp') {
                    app.addLayerFromDataset(
                        ds.rtp,
                        [
                            new gviz.SquareColorWGLStyle({
                                colorCol: 'rp', // pp ra rp
                                color: d3.interpolateGnBu,
                                tFun: (v, r, s) => Math.min(v, 100) / 100,
                                stretching: { fun: 'expRev', alpha: 2 },
                            }),
                            new gviz.StrokeStyle({
                                strokeColorCol: 'rp',
                                strokeColor: (v) => (+v ? '#666' : ''),
                                maxZoom: 100,
                            }),
                        ],
                        {
                            pixNb: 1,
                            cellInfoHTML: (c) => '<b>' + c.rp + '</b> road transport performance',
                            preprocess: (c) => c.rp != '',
                        }
                    )

                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: 'Road transport performance',
                            width: 300,
                            ticks: 9,
                            colorRamp: d3.interpolateGnBu,
                            fun: (t, r, s) => 100 * gviz.sExpRevInverse(t, 2),
                        })
                    )

                    //accessibility
                } else if (layCode === 'accHealth') {
                    //define class colors
                    const colorsH = {},
                        colorsH_ = []
                    for (let cid = 0; cid < breaksH.length + 1; cid++) {
                        colorsH[cid] = d3.interpolateSpectral(gviz.sPow(1 - cid / breaksH.length, 2))
                        colorsH_.push(colorsH[cid])
                    }
                    colorsH.NA = '#0002'

                    const cHTML = (c) => {
                        const txt =
                            c.avg_time_nearest_h == 'NA'
                                ? 'Unknown time'
                                : '<b>' + c.avg_time_nearest_h + '</b> min.'
                        return (
                            txt +
                            ' to nearest health service<br><b>' +
                            c.TOT_P +
                            '</b> inhabitant' +
                            (+c.TOT_P == 1 ? '' : 's')
                        )
                    }

                    //common styles
                    const strokeStyle = new gviz.StrokeStyle({ maxZoom: 70 })
                    const popStyle = new gviz.ShapeColorSizeStyle({
                        color: () => '#000000aa',
                        sizeCol: 'TOT_P',
                        size: (v, r, s, zf) => 1.2 * r * gviz.sPow(v / s.max, 0.3),
                        shape: () => 'circle',
                    })
                    //set legend
                    popStyle.legends.push(
                        new gviz.SizeLegend({
                            shape: 'circle',
                            labelUnitText: 'inhabitants',
                            fillColor: '#000000dd',
                        })
                    )

                    app.addLayerFromDataset(
                        ds.acc,
                        [
                            new gviz.SquareColorCatWGLStyle({
                                colorCol: 'cH',
                                color: colorsH,
                            }),
                            strokeStyle,
                        ],
                        {
                            pixNb: 1.5,
                            cellInfoHTML: cHTML,
                        }
                    )
                    app.addLayerFromDataset(ds.acc, [popStyle], {
                        pixNb: 1.5,
                        maxZoom: 300,
                        cellInfoHTML: cHTML,
                    })

                    //legends
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorDiscreteLegend({
                            title: 'Travel time to nearest health service, in minutes',
                            colors: colorsH_,
                            breaksText: breaksH,
                            width: 300,
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            colCat: [[colorsH.NA, 'No data']],
                            shape: 'square',
                        })
                    )
                } else if (layCode === 'accEducPrim') {
                    //define class colors
                    const colorsE = {},
                        colorsE_ = []
                    for (let cid = 0; cid < breaksE.length + 1; cid++) {
                        colorsE[cid] = d3.interpolateSpectral(gviz.sPow(1 - cid / breaksE.length, 2))
                        colorsE_.push(colorsE[cid])
                    }
                    colorsE.NA = '#0002'

                    const cHTML = (c) => {
                        const txt =
                            c.avg_time_nearest_ep == 'NA'
                                ? 'Unknown time'
                                : '<b>' + c.avg_time_nearest_ep + '</b> min.'
                        return (
                            txt +
                            ' to nearest primary education service<br><b>' +
                            c.TOT_P +
                            '</b> inhabitant' +
                            (+c.TOT_P == 1 ? '' : 's')
                        )
                    }

                    //common styles
                    const strokeStyle = new gviz.StrokeStyle({ maxZoom: 70 })
                    const popStyle = new gviz.ShapeColorSizeStyle({
                        color: () => '#000000aa',
                        sizeCol: 'TOT_P',
                        size: (v, r, s, zf) => 1.2 * r * gviz.sPow(v / s.max, 0.3),
                        shape: () => 'circle',
                    })
                    //set legend
                    popStyle.legends.push(
                        new gviz.SizeLegend({
                            shape: 'circle',
                            labelUnitText: 'inhabitants',
                            fillColor: '#000000dd',
                        })
                    )

                    app.addLayerFromDataset(
                        ds.acc,
                        [
                            new gviz.SquareColorCatWGLStyle({
                                colorCol: 'cE',
                                color: colorsE,
                            }),
                            strokeStyle,
                        ],
                        {
                            pixNb: 1.5,
                            cellInfoHTML: cHTML,
                        }
                    )
                    app.addLayerFromDataset(ds.acc, [popStyle], {
                        pixNb: 1.5,
                        maxZoom: 300,
                        cellInfoHTML: cHTML,
                    })

                    //legends
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorDiscreteLegend({
                            title: 'Travel time to nearest primary education service, in minutes',
                            colors: colorsE_,
                            breaksText: breaksE,
                            width: 300,
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            colCat: [[colorsE.NA, 'No data']],
                            shape: 'square',
                        })
                    )
                } else {
                    console.log('Unexpected layer code: ' + layCode)
                    return
                }

                //redraw
                app.cg.redraw()
            }

            //layer selection change
            document.querySelector('#layer').addEventListener('change', function () {
                const layCode = document.querySelector('input[name="layer"]:checked').value
                if (layCode == 'popChange') {
                    //enable years lists
                    document.querySelector('#pcyIni').disabled = false
                    document.querySelector('#pcyFin').disabled = false
                } else {
                    //disable years lists
                    document.querySelector('#pcyIni').disabled = true
                    document.querySelector('#pcyFin').disabled = true
                }

                update()
            })

            //population change - years change
            document.querySelector('#pcyIni').addEventListener('change', update)
            document.querySelector('#pcyFin').addEventListener('change', update)

            // show/hide labels
            document.querySelector('#label').addEventListener('change', function () {
                app.showLabels = this.checked
                app.cg.redraw()
            })

            // show/hide boundaries
            document.querySelector('#boundary').addEventListener('change', function () {
                app.showBoundaries = this.checked
                app.cg.redraw()
            })

            //select layer from URL
            const ls = gviz.getParameterByName('lay')
            if (ls) {
                const b = document.querySelector('#' + ls)
                if (b) b.checked = true
            }

            //initialise
            update()
        </script>

        <div
            style="
                position: absolute;
                right: 0px;
                bottom: 0px;
                width: auto;
                height: auto;
                padding: 1px;
                border: 0px;
                background: #ffffffcc;
            "
        >
            <span style="font-size: 0.8em; font-family: sans-serif"
                ><a
                    target="_blank"
                    rel="nofollow noreferrer noopener"
                    href="https://github.com/eurostat/gridviz"
                    style="text-decoration: none"
                    >GridViz</a
                >
                | ©
                <a
                    target="_blank"
                    rel="nofollow noreferrer noopener"
                    href="https://eurogeographics.org"
                    style="text-decoration: none"
                    >EuroGeographics</a
                >
                | ©
                <a
                    target="_blank"
                    rel="nofollow noreferrer noopener"
                    href="https://www.tuik.gov.tr"
                    style="text-decoration: none"
                    >Turkstat</a
                >
            </span>
        </div>
    </body>
</html>
