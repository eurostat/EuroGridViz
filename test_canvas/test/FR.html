<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <div id="viz-container" style="height:100%; width:100%;"></div>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <span style="font-size: 1.8em; font-weight: bold;">France</span>
        <span style="font-size: 1.25em;">
            <div id="layer">
                Year: <select id="year">
                    <option value="2015">2015</option>
                    <option value="2017" selected>2017</option>
                </select>
                <br>
                <span style="font-size: 1.25em; font-weight: bold;">Population</span><br>
                <input type="radio" name="layer" id="pop" value="pop" checked>
                <label for="pop">Population totale</label>
                <br>
                <input type="radio" name="layer" id="popAge" value="popAge">
                <label for="popAge">Par âge</label>
                <input type="radio" name="layer" id="popAge3" value="popAge3">
                <label for="popAge3">Par âge (3 groupes)</label>
                <br>
                <input type="radio" name="layer" id="ageR" value="ageR">
                <label for="ageR">Equilibre jeunes/âgés</label>
                <br>
                <input type="radio" name="layer" id="income" value="income">
                <label for="income">Revenus</label>
                <input type="radio" name="layer" id="poverty" value="poverty">
                <label for="poverty">Pauvreté</label>
                <br>
                <span style="font-size: 1.25em; font-weight: bold;">Ménages</span><br>
                <input type="radio" name="layer" id="men_size" value="men_size">
                <label for="men_size">Taille</label>
                <input type="radio" name="layer" id="men_mono" value="men_mono">
                <label for="men_mono">Monoparental</label>
                <br>
                <span style="font-size: 1.25em; font-weight: bold;">Logement</span><br>
                <input type="radio" name="layer" id="men_owner" value="men_owner">
                <label for="men_owner">Propriétaires</label>
                <br>
                <input type="radio" name="layer" id="men_house_surf" value="men_house_surf">
                <label for="men_house_surf">Surface</label>
                <br>
                <input type="radio" name="layer" id="men_house_collective" value="men_house_collective">
                <label for="men_house_collective">Maison / logement collectif</label>
                <br>
                <input type="radio" name="layer" id="log_age" value="log_age">
                <label for="log_age">Par année de construction</label>
                <br>
                Logement social:
                <input type="radio" name="layer" id="log_soc_nb" value="log_soc_nb">
                <label for="log_soc_nb">Nombre</label>
                <input type="radio" name="layer" id="log_soc_per" value="log_soc_per">
                <label for="log_soc_per">Pourcentage</label>
            </div>
            <hr>
            <input type="checkbox" id="label" checked>
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked>
            <label for="boundary">Boundaries</label>
            <hr>Source: <a href="https://www.insee.fr/fr/statistiques/4176290?sommaire=4176305" target="_blank"
                rel="noopener noreferrer">INSEE - Filosofi 2015/2017 - 200m grid</a>
        </span>
    </div>

    <script src="../build/gridvizc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script>

        let containerDiv = document.getElementById("viz-container");
        const app = new gviz.App(containerDiv)
            .setGeoCenter({ x: 3763437, y: 2891045 }).setZoomFactor(50.1).setZoomFactorExtent([7, 2000])
            .setLabelLayer(gviz.getEuronymeLabelLayer("FR", "20"))
            .setBoundaryLayer(gviz.getEurostatBoundariesLayer())
            .setViewFromURL()


        //prepare datasets, indexed by thematic domain and year
        const ds = { ind: {}, men: {}, log: {} }

        //population stats dataset
        const indDatasetFun = year => app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi/ind/" + year + "/",
            [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
            r => r + "m/",
            {
                preprocess: c => {
                    c.Ind_0_17 = +c.Ind_0_3 + +c.Ind_4_5 + +c.Ind_6_10 + +c.Ind_11_17
                    c.Ind_18_64 = +c.Ind_18_24 + +c.Ind_25_39 + +c.Ind_40_54 + +c.Ind_55_64
                    c.Ind_65p = +c.Ind_65_79 + +c.Ind_80p

                    c.rIncome = c.Ind_snv / c.Ind / 12;

                    //<24
                    c.yyy = +c.Ind_0_3 + +c.Ind_4_5 + +c.Ind_6_10 + +c.Ind_11_17 + +c.Ind_18_24;
                    //>65
                    c.ooo = +c.Ind_65_79 + +c.Ind_80p
                    c.age_ratio = c.yyy + c.ooo == 0 ? 0 : (c.yyy - c.ooo) / (c.yyy + c.ooo);
                    c.age_ratio = c.age_ratio * 0.5 + 0.5
                }
            }
        )
        ds.ind["2015"] = indDatasetFun(2015)
        ds.ind["2017"] = indDatasetFun(2017)

        //household stats dataset
        const menDatasetFun = year => app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi/men/" + year + "/",
            [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
            r => r + "m/",
            {
                preprocess: c => {
                    //ind per men
                    c.indPerMEn = c.Ind / c.Men;
                    //poverty
                    c.rPoverty = c.Men_pauv / c.Men;
                    // Men_1ind - Nombre de ménages d’un seul individu
                    //c.rMen1ind = c.Men_1ind / c.Men;
                    // Men_5ind - Nombre de ménages de 5 individus ou plus
                    //c.rMen5p = c.Men_5ind / c.Men;
                    c.Men_2_4ind = +c.Men - +c.Men_1ind - +c.Men_5ind;
                    // Men_prop - Nombre de ménages propriétaires
                    c.rMenProp = c.Men_prop / c.Men;
                    // Men_fmp - Nombre de ménages monoparentaux
                    c.rMenFmp = c.Men_fmp / c.Men;
                    // Men_surf - Somme de la surface des logements* du carreau
                    c.rMenSurf = +c.Men_surf / +c.Men;
                }
            }
        )
        ds.men["2015"] = menDatasetFun(2015)
        ds.men["2017"] = menDatasetFun(2017)

        //housing stats dataset
        const logDatasetFun = year => app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi/log/2015/",
            [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
            r => r + "m/",
            {
                preprocess: c => {
                    c.Log = +c.Log_av45 + +c.Log_45_70 + +c.Log_70_90 + +c.Log_ap90 + +c.Log_inc
                    // Log_soc - Nombre de logements* sociaux
                    c.Log_nsoc = +c.Log - +c.Log_soc;
                    c.rLogSoc = c.Log_soc / c.Log;
                }
            }
        )
        ds.log["2015"] = logDatasetFun(2015)
        ds.log["2017"] = logDatasetFun(2017)




        //
        const update = () => {

            //read GUI selection
            const layCode = document.querySelector('input[name="layer"]:checked').value
            const year = document.querySelector('#year').value

            //remove layers
            app.layers = []

            //formater
            const f1 = d3.format(".1f")

            //set layer
            if (layCode === "pop") {
                //population
                app.addMultiScaleTiledGridLayer2(
                    ds.ind[year],
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "Ind",
                            color: (v, r, s) => gviz.interpolateOrRd(gviz.s(v / s.max, 0.25)),
                        }), new gviz.StrokeStyle({ zf: 15 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => "<b>" + c.Ind + "</b> habitant(s)",
                    }
                )
            } else if (layCode === "popAge") {
                //population by age
                const col = gviz.interpolateSpectral
                app.addMultiScaleTiledGridLayer2(
                    ds.ind[year],
                    [
                        new gviz.CompositionStyle({
                            color: {
                                "Ind_0_3": col(0 / 80),
                                "Ind_4_5": col(2 / 80),
                                "Ind_6_10": col(7 / 80),
                                "Ind_11_17": col(14 / 80),
                                "Ind_18_24": col(21 / 80),
                                "Ind_25_39": col(36 / 80),
                                "Ind_40_54": col(51 / 80),
                                "Ind_55_64": col(61 / 80),
                                "Ind_65_79": col(76 / 80),
                                "Ind_80p": col(1),
                                //"Ind_inc": "black"
                            },
                            type: () => "agepyramid",
                            sizeCol: "Ind",
                            size: (v, r, s, zf) => r * gviz.s(v / s.max, 0.1, 0),
                            agePyramidHeight: (r) => 0.95 * r
                        })
                    ],
                    {
                        pixNb: 16,
                        cellInfoHTML: c => "<b>" + c.Ind + "</b> habitant(s)<br>" + "Par âge:<br>" +
                            " < 3 : " + c.Ind_0_3 + "<br>" +
                            " 4-5 : " + c.Ind_4_5 + "<br>" +
                            " 6-10: " + c.Ind_6_10 + "<br>" +
                            "11-17: " + c.Ind_11_17 + "<br>" +
                            "18-24: " + c.Ind_18_24 + "<br>" +
                            "25-39: " + c.Ind_25_39 + "<br>" +
                            "40-54: " + c.Ind_40_54 + "<br>" +
                            "55-64: " + c.Ind_55_64 + "<br>" +
                            "65-79: " + c.Ind_65_79 + "<br>" +
                            " > 80: " + c.Ind_80p + "<br>" +
                            " inc.: " + c.Ind_inc
                    })
            } else if (layCode === "popAge3") {
                //population by age (3 age groups)
                const col = gviz.interpolateSpectral
                app.addMultiScaleTiledGridLayer2(
                    ds.ind[year],
                    [
                        new gviz.CompositionStyle({
                            color: {
                                "Ind_0_17": col(0.2),
                                "Ind_18_64": col(0.4),
                                "Ind_65p": col(0.9),
                            },
                            type: () => "agepyramid",
                            sizeCol: "Ind",
                            size: (v, r, s, zf) => r * gviz.s(v / s.max, 0.1, 0),
                            agePyramidHeight: (r) => 0.95 * r
                        })
                    ],
                    {
                        pixNb: 12,
                        cellInfoHTML: c => "<b>" + c.Ind + "</b> habitant(s)<br>" + "Par âge:<br>" +
                            " < 17 : " + f1(c.Ind_0_17) + "<br>" +
                            " 18-64 : " + f1(c.Ind_18_64) + "<br>" +
                            " > 65: " + f1(c.Ind_65p) + "<br>" +
                            " inc.: " + f1(c.Ind_inc)
                    })
            } else if (layCode === "ageR") {
                //young VS elderly
                app.addMultiScaleTiledGridLayer2(
                    ds.ind[year],
                    [
                        new gviz.ShapeColorSizeStyle({
                            sizeCol: "Ind",
                            size: (v, r, s, zf) => 1.4 * r * Math.pow(v / s.max, 0.2),
                            colorCol: "age_ratio",
                            color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow(v, 1)),
                            shape: () => "circle",
                        })
                    ],
                    {
                        pixNb: 6,
                        cellInfoHTML: c => "<b>" + f1(c.yyy) + "</b> 24 ans et moins"
                            + "<br>" + "<b>" + f1(c.ooo) + "</b> 65 ans et plus"
                            + "<br>" + "(Déséquilibre: " + (Math.round(c.age_ratio * 100)) + "%)"
                    })
            } else if (layCode === "income") {
                //income
                app.addMultiScaleTiledGridLayer2(
                    ds.ind[year],
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "rIncome",
                            color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow((v - s.min) / (s.max - s.min), 1.5)),
                        }),
                        new gviz.StrokeStyle({ zf: 15 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => "<b>" + Math.floor(c.rIncome) + "€</b> par mois et par 'individu'",
                    })

            } else if (layCode === "poverty") {
                //poverty
                app.addMultiScaleTiledGridLayer2(
                    ds.men[year],
                    [
                        new gviz.ShapeColorSizeStyle({
                            sizeCol: "Men",
                            size: (v, r, s, zf) => 1.4 * r * Math.pow(v / s.max, 0.2),
                            colorCol: "rPoverty",
                            color: (v, r, s) => {
                                if (!v) return "#bbb"
                                return gviz.interpolateOrRd(Math.pow((v - s.min) / (s.max - s.min), 0.7))
                            },
                            shape: () => "circle",
                        })
                        /*new gviz.SquareColoringWebGLStyle({
                                colorCol: "rPoverty",
                                color: (v, r, s) => {
                                    if (!v) return "#bbb"
                                    return gviz.interpolateReds(Math.pow((v - s.min) / (s.max - s.min), 0.7))
                                },
                            }),
                            new gviz.StrokeStyle({ zf: 15 })*/
                    ],
                    {
                        pixNb: 6,
                        cellInfoHTML: c => "<b>" + f1(Math.floor(1000 * c.rPoverty) / 10) + "%</b> de ménages pauvres<br>"
                            + "sur " + c.Men + " ménages",
                    })
                /*} else if (layCode === "men_1ind") {
                    //rate 1
                    app.addMultiScaleTiledGridLayer2(
                        ds.men[year],
                        [
                            new gviz.SquareColoringWebGLStyle({
                                colorCol: "rMen1ind",
                                color: (v, r, s) => {
                                    return gviz.interpolateSpectral(1 - Math.pow(v / s.max, 0.7))
                                },
                            }),
                            new gviz.StrokeStyle({ zf: 15 })
                        ],
                        {
                            pixNb: 2,
                            cellInfoHTML: c => "<b>" + f1(Math.floor(1000 * c.rMen1ind) / 10) + "%</b> de ménages d'un seul individu.",
                        })
                } else if (layCode === "men_5pind") {
                    //rate 5p
                    app.addMultiScaleTiledGridLayer2(
                        ds.men[year],
                        [
                            new gviz.SquareColoringWebGLStyle({
                                colorCol: "rMen5p",
                                color: (v, r, s) => {
                                    return gviz.interpolateSpectral(1 - Math.pow(v / s.max, 0.7))
                                },
                            }),
                            new gviz.StrokeStyle({ zf: 15 })
                        ],
                        {
                            pixNb: 2,
                            cellInfoHTML: c => "<b>" + f1(Math.floor(1000 * c.rMen5p) / 10) + "%</b> de ménages de 5 individus ou plus.",
                        })*/
            } else if (layCode === "men_size") {
                //houshold size
                app.addMultiScaleTiledGridLayer2(
                    ds.men[year],
                    [
                        new gviz.CompositionStyle({
                            color: {
                                "Men_2_4ind": "#1f78b4",
                                "Men_1ind": "#ffff99",
                                "Men_5ind": "#e31a1c",
                            },
                            type: () => "ring",
                            stripesOrientation: () => 90,
                            sizeCol: "Men",
                            size: (v, r, s, zf) => 1.3 * r * gviz.s(v / s.max, 0.15, 0),
                        })
                    ],
                    {
                        pixNb: 10,
                        cellInfoHTML: c => c.Men + " ménage(s)"
                        + "<br><b>" + c.Men_1ind + "</b> d'un seul individu"
                        + "<br><b>" + f1(c.Men_2_4ind) + "</b> de 2 à 4 individus"
                         + "<br><b>" + c.Men_5ind + "</b> de plus de 5 individus"
                    })

            } else if (layCode === "men_owner") {
                //rate owners
                app.addMultiScaleTiledGridLayer2(
                    ds.men[year],
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "rMenProp",
                            color: (v, r, s) => {
                                return gviz.interpolateSpectral(1 - Math.pow(v / s.max, 0.7))
                            },
                        }),
                        new gviz.StrokeStyle({ zf: 15 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => "<b>" + f1(Math.floor(1000 * c.rMenProp) / 10) + "%</b> de ménages propriétaires.",
                    })

            } else if (layCode === "men_mono") {
                //rate monoparental
                app.addMultiScaleTiledGridLayer2(
                    ds.men[year],
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "rMenFmp",
                            color: (v, r, s) => {
                                return gviz.interpolateSpectral(1 - Math.pow(v / s.max, 0.7))
                            },
                        }),
                        new gviz.StrokeStyle({ zf: 15 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => "<b>" + f1(Math.floor(1000 * c.rMenFmp) / 10) + "%</b> de ménages monoparentaux.",
                    })

            } else if (layCode === "men_house_surf") {
                //housing surface per houshold
                app.addMultiScaleTiledGridLayer2(
                    ds.men[year],
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "rMenSurf",
                            color: (v, r, s) => {
                                return gviz.interpolateSpectral(1 - Math.pow((v - s.min) / (s.max - s.min), 1))
                            },
                        }),
                        new gviz.StrokeStyle({ zf: 15 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => "<b>" + f1(Math.floor(10 * c.rMenSurf) / 10) + "</b> m² par ménage."
                            + "<br>" + c.Men + " ménage(s)"
                    })

            } else if (layCode === "men_house_collective") {
                //housing type: house/collective
                app.addMultiScaleTiledGridLayer2(
                    ds.men[year],
                    [
                        new gviz.CompositionStyle({
                            color: {
                                "Men_coll": "green",
                                "Men_mais": "orange",
                            },
                            type: () => "flag",
                            stripesOrientation: () => 90,
                            sizeCol: "Men",
                            size: (v, r, s, zf) => r * gviz.s(v / s.max, 0.15, 0),
                        })
                    ],
                    {
                        pixNb: 8,
                        cellInfoHTML: c => c.Men + " ménage(s)<br>" +
                            "<b>" + c.Men_coll + "</b> en logement collectif<br>" +
                            "<b>" + c.Men_mais + "</b> en maison"
                    })


            } else if (layCode === "log_age") {
                //housing age
                const col = gviz.interpolateViridis
                app.addMultiScaleTiledGridLayer2(
                    ds.log[year],
                    [
                        new gviz.CompositionStyle({
                            color: {
                                "Log_av45": col(0 / 3),
                                "Log_45_70": col(1 / 3),
                                "Log_70_90": col(2 / 3),
                                "Log_ap90": col(3 / 3),
                                "Log_inc": "black"
                            },
                            type: () => "flag",
                            //stripesOrientation: () => 90,
                            sizeCol: "Log",
                            size: (v, r, s, zf) => r * gviz.s(v / s.max, 0.1, 0),
                        })
                    ],
                    {
                        pixNb: 8,
                        cellInfoHTML: c => c.Log + " logements(s)<br>" + "Année de construction:<br>" +
                            "<b>" + c.Log_av45 + "</b> avant 1945<br>" +
                            "<b>" + c.Log_45_70 + "</b> entre 1945 et 1969<br>" +
                            "<b>" + c.Log_70_90 + "</b> entre 1970 et 1989<br>" +
                            "<b>" + c.Log_ap90 + "</b> depuis 1990<br>" +
                            "<b>" + c.Log_inc + "</b> inconnue(s)"
                    })

            } else if (layCode === "log_soc_nb") {
                //social housing
                app.addMultiScaleTiledGridLayer2(
                    ds.log[year],
                    [
                        new gviz.CompositionStyle({
                            color: {
                                "Log_nsoc": "#777",
                                "Log_soc": "#33a02c",
                            },
                            type: () => "ring",
                            sizeCol: "Log",
                            size: (v, r, s, zf) => 1.3 * r * gviz.s(v / s.max, 0.15, 0),
                        })
                    ],
                    {
                        pixNb: 8,
                        cellInfoHTML: c => c.Log + " logement(s)<br>" +
                            "<b>" + c.Log_soc + "</b> logement(s) social(ux)<br>" +
                            "<b>" + c.Log_nsoc + "</b> Autre(s)"
                    })

            } else if (layCode === "log_soc_per") {
                //social housing percentage
                app.addMultiScaleTiledGridLayer2(
                    ds.log[year],
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "rLogSoc",
                            color: (v, r, s) => gviz.interpolateSpectral(1 - v),
                        }),
                        new gviz.StrokeStyle({ zf: 15 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => "<b>" + f1(Math.floor(1000 * c.rLogSoc) / 10) + "%</b> de logements sociaux.",
                    })

            } else console.error("Unexpected layer code: " + layCode);

            //redraw
            app.cg.redraw();
        }

        //layer and year update
        document.querySelector('#layer').addEventListener('change', update)
        document.querySelector('#year').addEventListener('change', update)

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw();
        });

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            app.showBoundaries = this.checked
            app.cg.redraw();
        });

        //initialise
        update()

    </script>

    <div
        style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
        <span style="font-size: 0.8em;"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration:none">GridViz</a> |
            © <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
    </div>

</body>

</html>