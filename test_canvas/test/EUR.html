<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <div id="viz-container" style="height:100%; width:100%;"></div>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <span style="font-size: 17pt; font-weight: bold;">Europe grid</span><br><span style="font-size: 10pt;">


            <hr>
            <div id="layer">
                <span style="font-size: 11pt; font-weight: bold;">Population in </span>
                <select id="yearPop">
                    <option value="2018" selected>2018</option>
                    <option value="2011">2011</option>
                    <option value="2006">2006</option>
                </select>
                <br>
                <input type="radio" name="layer" id="squareColor" value="squareColor" checked>
                <label for="squareColor">Color</label>
                <input type="radio" name="layer" id="circleSize" value="circleSize">
                <label for="circleSize">Size</label>
                <input type="radio" name="layer" id="dots" value="dots">
                <label for="dots">Dots</label>
                <br>
                <input type="radio" name="layer" id="joyplot" value="joyplot">
                <label for="joyplot">Joyplot</label>
                <input type="radio" name="layer" id="tanaka" value="tanaka">
                <label for="tanaka">Tanaka</label>
                <input type="radio" name="layer" id="lego" value="lego">
                <label for="lego">Lego</label>
                <hr>
                <span style="font-size: 11pt; font-weight: bold;">Population change</span><br>
                <select id="yearPopCh">
                    <option value="d11_18" selected>from 2011 to 2018</option>
                    <option value="d06_11">from 2006 to 2011</option>
                </select>
                <br>
                <input type="radio" name="layer" id="squareColorCh" value="squareColorCh">
                <label for="squareColorCh">Color</label>
                <input type="radio" name="layer" id="SegOCh" value="SegOCh">
                <label for="SegOCh">Hatching</label>
                <hr>
                <span style="font-size: 11pt; font-weight: bold;">Accessibility</span>
                <br>
                <input type="radio" name="layer" id="accHealth" value="accHealth">
                <label for="accHealth">Healthcare services</label>
            </div>

            <hr>
            <input type="checkbox" id="label" checked>
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked>
            <label for="boundary">Boundaries</label>
            <hr>Source: <a href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/grids" target="_blank"
                rel="noopener noreferrer">European Commission</a>
        </span>
    </div>

    <div id="zoomSlider" style="display: block; position: absolute; right: 20px; top: 20px;"></div>

    <script src="../build/gridvizc.js"></script>
    <script>

        let containerDiv = document.getElementById("viz-container");
        const app = new gviz.App(containerDiv)
            .setGeoCenter({ x: 4000000, y: 2960000 }).setZoomFactor(600).setZoomFactorExtent([40, 7500])
            .setLabelLayer(gviz.getEuronymeLabelLayer()).setBoundaryLayer(gviz.getEurostatBoundariesLayer())
            .addZoomSlider("zoomSlider")
            .setViewFromURL()


        //prepare layers
        const resolutions = [1000, 2000, 5000, 10000, 20000, 50000, 100000]
        //for population
        const layPop = app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/grid_pop_tiled/",
            resolutions, r => Math.round(r / 1000) + "km/", [], {}
        )
        //for accessibility
        const layAcc = app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/accessibility/tiled/",
            resolutions, r => r + "m/", [], {}
        )

        //
        const update = () => {

            //read GUI selection
            const layCode = document.querySelector('input[name="layer"]:checked').value
            const yearPop = document.querySelector('#yearPop').value
            const yearPopCh = document.querySelector('#yearPopCh').value

            //select right layer, style and resolution
            let lay
            switch (layCode) {

                case "squareColor":
                    layPop.setStyles([new gviz.SquareColoringWebGLStyle({
                        colorCol: yearPop,
                        color: (v, r, s) => gviz.interpolateOrRd(gviz.s(v / s.max, 0.25)),
                    }), new gviz.StrokeStyle({ zf: 80 })
                    ])
                    layPop.pixNb = 5;
                    lay = layPop
                    break;
                case "circleSize":
                    layPop.setStyles([new gviz.ShapeColorSizeStyle({
                        color: () => "#c08c59cc",
                        sizeCol: yearPop,
                        size: (v, r, s, zf) => 1.5 * r * gviz.s(v / s.max, 0.3),
                        shape: () => "circle",
                    })])
                    layPop.pixNb = 15;
                    lay = layPop
                    break;
                case "dots":
                    layPop.setStyles([new gviz.DotDensityStyle({
                        col: yearPop,
                        nb: (v, r, s, zf) => 1 * r * r / (zf * zf) * gviz.s(v / s.max, 0.4),
                        dotSize: (r, zf) => 1.2 * zf,
                        color: () => "#FF5733"
                    })])
                    layPop.pixNb = 10;
                    lay = layPop
                    break;
                case "joyplot":
                    layPop.setStyles([new gviz.JoyPlotStyle({
                        heightCol: yearPop,
                        height: (v, r, s, zf) => 5 * r * Math.sqrt(v / s.max),
                        fillColor: "#c08c59bb"
                    })])
                    layPop.pixNb = 10;
                    lay = layPop
                    break;
                case "tanaka":
                    layPop.setStyles(gviz.getTanakaStyle(yearPop, { valueStretch: (v, r, s, zf) => gviz.s((v - s.min) / (s.max - s.min), 0.2) }))
                    layPop.pixNb = 10;
                    lay = layPop
                    break;
                case "lego":
                    layPop.setStyles(gviz.getLegoStyle(yearPop, { valueStretch: (v, r, s, zf) => gviz.s((v - s.min) / (s.max - s.min), 0.2) }))
                    layPop.pixNb = 20;
                    lay = layPop
                    break;

                case "accHealth":
                    //acc healthcare
                    const breaks = [0, 5, 10, 15, 20, 25, 30, 35, 40, 50, 60, 90]
                    layAcc.setStyles([
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: "avg_time_nearest_h",
                            color: (v, r, s) => {
                                if (v === "NA") return
                                let i = 0
                                for (let b of breaks) {
                                    if (+v <= b) break;
                                    i++
                                }
                                const t = gviz.s(1 - (i - 1) / breaks.length, 2)
                                return gviz.interpolateSpectral(t)
                            },
                        }),
                        new gviz.StrokeStyle({ zf: 80 }),
                        new gviz.ShapeColorSizeStyle({
                            color: () => "#000000dd",
                            sizeCol: "TOT_P",
                            size: (v, r, s, zf) => 1.2 * r * gviz.s(v / s.max, 0.3),
                            shape: () => "circle",
                        })
                    ])
                    layAcc.pixNb = 20;
                    lay = layAcc
                    break;

                default:
                    console.log("Unexpected layer code: " + layCode);
                    return;
            }

            //set layer
            app.layers = [lay]

            app.cg.redraw();
        }



        //layer selector
        document.querySelector('#layer').addEventListener('change', update)

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw();
        });

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            app.showBoundaries = this.checked
            app.cg.redraw();
        });

    </script>

    <div
        style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
        <span style="font-size: 8pt;"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration:none">GridViz</a> |
            Â© <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
    </div>

</body>

</html>