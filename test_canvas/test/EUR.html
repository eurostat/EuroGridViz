<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <div id="viz-container" style="height:100%; width:100%;"></div>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <span style="font-size: 1.8em; font-weight: bold;">Europe grid</span><br>
        <span style="font-size: 1.25em;">
            <hr>
            <div id="layer">

                <span style="font-size: 1.25em; font-weight: bold;">Population</span>
                <br>
                <input type="radio" name="layer" id="2018" value="2018" checked>
                <label for="2018">2018</label>
                <input type="radio" name="layer" id="2011" value="2011">
                <label for="2011">2011</label>
                <input type="radio" name="layer" id="2006" value="2006">
                <label for="2006">2006</label>
                <hr>

                <span style="font-size: 1.25em; font-weight: bold;">Population change</span>
                <br>
                <input type="radio" name="layer" id="d11_18" value="d11_18">
                <label for="d11_18">2011 to 2018</label>
                <br>
                <input type="radio" name="layer" id="d06_11" value="d06_11">
                <label for="d06_11">2006 to 2011</label>
                <hr>

                <span style="font-size: 1.25em; font-weight: bold;">Accessibility</span>
                <br>
                <input type="radio" name="layer" id="accHealth" value="accHealth">
                <label for="accHealth">Healthcare services</label>
                <br>
                <input type="radio" name="layer" id="accEducPrim" value="accEducPrim">
                <label for="accEducPrim">Primary schools</label>
            </div>

            <hr>
            <input type="checkbox" id="label" checked>
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked>
            <label for="boundary">Boundaries</label>
            <hr>Source: <a href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/grids" target="_blank"
                rel="noopener noreferrer">European Commission</a>
        </span>
    </div>

    <script src="../build/gridvizc.js"></script>
    <script>

        let containerDiv = document.getElementById("viz-container");
        const app = new gviz.App(containerDiv)
            .setGeoCenter({ x: 4000000, y: 2960000 }).setZoomFactor(600).setZoomFactorExtent([40, 7500])
            .setLabelLayer(gviz.getEuronymeLabelLayer()).setBoundaryLayer(gviz.getEurostatBoundariesLayer())
            .setViewFromURL()

        //prepare datasets
        const ds = {}

        //population dataset
        ds.pop = app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/grid_pop_tiled/",
            [1000, 2000, 5000, 10000, 20000, 50000, 100000], r => Math.round(r / 1000) + "km/",
            {
                preprocess: c => {
                    //prepare 2011 -> 2018 change data
                    if (!c["2011"] && !c["2018"]) c.d11_18 = 0
                    else if (!c["2011"] && c["2018"]) c.d11_18 = + c["2018"]
                    else if (c["2011"] && !c["2018"]) c.d11_18 = - c["2011"]
                    else c.d11_18 = c["2018"] - c["2011"]

                    //prepare 2006 -> 2011 change data
                    if (!c["2006"] && !c["2011"]) c.d06_11 = 0
                    else if (!c["2006"] && c["2011"]) c.d06_11 = +c["2011"]
                    else if (c["2006"] && !c["2011"]) c.d06_11 = - c["2006"]
                    else c.d06_11 = c["2011"] - c["2006"]
                }
            }
        )

        //accessibility dataset
        ds.acc = app.makeMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/Europe/accessibility/tiled/",
            [1000, 2000, 5000, 10000, 20000, 50000, 100000], r => r + "m/"
        )


        //
        const update = () => {

            //read GUI selection
            const layCode = document.querySelector('input[name="layer"]:checked').value

            //remove layers
            app.layers = []

            //select layer and style
            if (layCode === "2006" || layCode === "2011" || layCode === "2018") {
                app.addMultiScaleTiledGridLayer2(
                    ds.pop,
                    [
                        new gviz.SquareColoringWebGLStyle({
                            colorCol: layCode,
                            color: (v, r, s) => v == 0 ? "" : gviz.interpolateOrRd(gviz.s(v / s.max, 0.25)),
                        }),
                        new gviz.StrokeStyle({ strokeColorCol: layCode, strokeColor: v => +v ? "#666" : "", maxZoom: 80 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => +c[layCode] ? "<b>" + c[layCode] + "</b> inhabitant(s) in " + layCode : undefined
                    }
                )
                //legend
                app.layers[0].styles[0].legends.push(new gviz.ColorLegend({ title: "Number of inhabitants", ticks: 6, colorRamp: gviz.interpolateOrRd, fun: (t, r, s) => s.max * Math.pow(t, 1 / 0.25) }))

            } else if (layCode === "d06_11" || layCode === "d11_18") {
                app.addMultiScaleTiledGridLayer2(
                    ds.pop,
                    [
                        new gviz.ShapeColorSizeStyle({
                            colorCol: layCode,
                            color: (v, r, s) => {
                                const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                                const t = Math.sign(v) * gviz.s(Math.abs(v) / max, 0.2) / 2 + 0.5
                                return gviz.interpolateSpectral(1 - t);
                            },
                            shape: () => "square",
                        }),
                        new gviz.StrokeStyle({ maxZoom: 80 })
                    ],
                    {
                        pixNb: 2,
                        cellInfoHTML: c => (
                            layCode === "d11_18" ?
                                "2011: " + c["2011"] + "<br>2018: " + c["2018"]
                                : "2006: " + c["2006"] + "<br>2011: " + c["2011"]
                        )
                            + "<br>"
                            + "<b>" + (c[layCode] == 0 ? "No change" : (c[layCode] > 0 ? "+" : "") + c[layCode] + " inhabitants") + "</b>"
                    }
                )
                //legend
                app.layers[0].styles[0].legends.push(
                    new gviz.ColorLegend({
                        title: "Population change", ticks: 7, colorRamp: gviz.interpolateSpectral, invert: true,
                        fun: (t, r, s) => {
                            const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                            return (t < 0.5 ? -1 : 1) * max * gviz.s(Math.abs(2 * t - 1), 1 / 0.2)
                        }
                    })
                )

                //accessibility

            } else if (layCode === "accHealth") {
                /*const lay = app.layers[1]
                const breaks = [0, 5, 10, 15, 20, 25, 30, 35, 40, 50, 60, 90]
                lay.styles = [
                    new gviz.SquareColoringWebGLStyle({
                        colorCol: "avg_time_nearest_h",
                        color: (v, r, s) => {
                            if (v === "NA") return
                            let i = 0
                            for (let b of breaks) {
                                if (+v <= b) break;
                                i++
                            }
                            const t = gviz.s(1 - (i - 1) / breaks.length, 2)
                            return gviz.interpolateSpectral(t)
                        },
                    }),
                    new gviz.StrokeStyle({ maxZoom: 80 }),
                    new gviz.ShapeColorSizeStyle({
                        color: () => "#000000dd",
                        sizeCol: "TOT_P",
                        size: (v, r, s, zf) => 1.2 * r * gviz.s(v / s.max, 0.3),
                        shape: () => "circle",
                    })
                ]
                //lay.styles = (gviz.getTanakaStyle("avg_time_nearest_h", { valueStretch: (v, r, s, zf) => gviz.s((v - s.min) / (s.max - s.min), 0.5) }))
                lay.pixNb = 8;
                lay.visible = true;
                lay.cellInfoHTML = (c) => {
                    return "<b>" + c.avg_time_nearest_h + "</b> min. to nearest service<br><b>" + c.TOT_P + "</b> inhabitant(s)"
                }
                //legends
                //TODO add legend with classified colors
                //lay.styles[0].legends.push(new gviz.ColorLegend({}))
                lay.styles[2].legends.push(new gviz.SizeLegend({ shape: "circle", labelUnitText: "inhab.", fillColor: "#000000dd" }))
*/

            } else if (layCode === "accEducPrim") {
                /*const lay = app.layers[1]
                const breaks = [0, 2, 4, 6, 8, 10, 20, 30]
                lay.styles = [
                    new gviz.SquareColoringWebGLStyle({
                        colorCol: "avg_time_nearest_ep",
                        color: (v, r, s) => {
                            if (v === "NA") return
                            let i = 0
                            for (let b of breaks) {
                                if (+v <= b) break;
                                i++
                            }
                            const t = gviz.s(1 - (i - 1) / breaks.length, 2)
                            return gviz.interpolateSpectral(t)
                        },
                    }),
                    new gviz.StrokeStyle({ maxZoom: 80 }),
                    new gviz.ShapeColorSizeStyle({
                        color: () => "#000000dd",
                        sizeCol: "TOT_P",
                        size: (v, r, s, zf) => 1.2 * r * gviz.s(v / s.max, 0.3),
                        shape: () => "circle",
                    })
                ]
                lay.pixNb = 8;
                lay.visible = true;
                lay.cellInfoHTML = (c) => {
                    return "<b>" + c.avg_time_nearest_ep + "</b> min. to nearest school<br><b>" + c.TOT_P + "</b> inhabitant(s)"
                }
                //legends
                //TODO add legend with classified colors
                //lay.styles[0].legends.push(new gviz.ColorLegend({}))
                lay.styles[2].legends.push(new gviz.SizeLegend({ shape: "circle", labelUnitText: "inhab.", fillColor: "#000000dd" }))
*/
            } else {
                console.log("Unexpected layer code: " + layCode);
                return;
            }

            //redraw
            app.cg.redraw();
        }

        //layer selector
        document.querySelector('#layer').addEventListener('change', update)

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw();
        });

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            app.showBoundaries = this.checked
            app.cg.redraw();
        });

        //initialise
        update()

    </script>

    <div
        style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
        <span style="font-size: 0.8em;"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration:none">GridViz</a> |
            © <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
    </div>

</body>

</html>