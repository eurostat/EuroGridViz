<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <canvas id="vacanvas" style="height:100%; width:100%;"></canvas>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <span style="font-size: 17pt; font-weight: bold;">Population of France by age</span><br><span
            style="font-size: 10pt;">
            <input type="checkbox" id="agg">
            <label for="agg">Aggregate to 3 age groups</label>
            <hr>
            <span style="font-size: 11pt; font-weight: bold;">Style</span><br>
            <div id="style">
                <input type="radio" name="style" id="flag" value="flag" checked>
                <label for="flag">Flag</label>
                <input type="radio" name="style" id="segment" value="segment">
                <label for="segment">Segment</label>
                <input type="radio" name="style" id="agepyramid" value="agepyramid">
                <label for="agepyramid">Age pyramid</label>
                <br>
                <input type="radio" name="style" id="ring" value="ring">
                <label for="ring">Ring</label>
                <input type="radio" name="style" id="radar" value="radar">
                <label for="radar">Radar</label>
                <input type="radio" name="style" id="piechart" value="piechart">
                <label for="piechart">Pie chart</label>
                <input type="radio" name="style" id="halftone" value="halftone">
                <label for="halftone">Halftone</label>
            </div>
            <input type="checkbox" id="adsize" checked>
            <label for="adsize">Size to total population</label>
            <hr>
            <input type="checkbox" id="label" checked>
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked>
            <label for="boundary">Boundaries</label>
            <hr>Source: <a href="https://www.insee.fr/fr/statistiques/4176290?sommaire=4176305" target="_blank"
                rel="noopener noreferrer">INSEE - Filosofi 2015 - 200m grid</a>
        </span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script src="../build/gridvizc.js"></script>
    <script>

        //make application
        const app = new gviz.App()
            .setGeoCenter({ x: 3763437, y: 2891045 }).setZoomFactor(100).setZoomFactorExtent([5, 1500])
            .setLabelLayer(gviz.getEuronymeLabelLayer("FR", "20", { haloWidth: () => 5, haloColor:()=>"#FFFFFFDD" })).setBoundaryLayer(gviz.getEurostatBoundariesLayer({
                color: (f, zf) => {
                    const p = f.properties
                    const col = "#888"
                    if (p.co === "T") return col //"#007577"
                    if (zf < 400) return col
                    else if (zf < 1000) return p.lvl >= 3 ? "" : col
                    else if (zf < 2000) return p.lvl >= 2 ? "" : col
                    else return p.lvl >= 1 ? "" : col
                },
                lineDash: () => [],
            }))

        //test view from URL parameters, if any
        app.cg.setViewFromURL()

        //get aggregation from UI
        const getAggUI = () => {
            return document.querySelector('#agg').checked
        }

        //get style from UI
        const getStyle = () => {
            const v = document.querySelector('input[name="style"]:checked').value
            s.setType(() => v)
            return s
        }

        const col = gviz.interpolateSpectral;
        //const col = gviz.interpolateTurbo;
        //const col = gviz.interpolateYlOrRd;
        const getColorDict = () => {
            if (getAggUI())
                return {
                    "Ind_0_17": col(0.2),
                    "Ind_18_64": col(0.4),
                    "Ind_65p": col(0.9),
                    /*"Ind_0_24": "#66a61e",
                    "Ind_25_54": "#e6ab02",
                    "Ind_55p": "#a6761d",*/
                    //"Ind_inc": "black"
                };
            else
                return {
                    "Ind_0_3": col(0 / 80),
                    "Ind_4_5": col(2 / 80),
                    "Ind_6_10": col(7 / 80),
                    "Ind_11_17": col(14 / 80),
                    "Ind_18_24": col(21 / 80),
                    "Ind_25_39": col(36 / 80),
                    "Ind_40_54": col(51 / 80),
                    "Ind_55_64": col(61 / 80),
                    "Ind_65_79": col(76 / 80),
                    "Ind_80p": col(1),
                    //"Ind_inc": "black"
                }
        }

        //labels for the legend
        const getLegendOpts = () => {
            const opts = { colorCat: { id: "guytextscatlegend", bottom: "20px", left: "20px", shape: "square" } }
            if (getAggUI()) {
                opts.colorCat.colCat = [[getColorDict()["Ind_0_17"], "< 17"], [getColorDict()["Ind_18_64"], "18 to 65"], [getColorDict()["Ind_65p"], "> 65"]]
                    .reverse()
            }
            else {
                opts.colorCat.colCat = [[col(0), "< 3"], [col(2 / 80), "4 to 5"], [col(7 / 80), "6 to 10"], [col(14 / 80), "11 to 17"],
                [col(21 / 80), "18 to 24"], [col(36 / 80), "25 to 39"], [col(51 / 80), "40 to 54"], [col(61 / 80), "55 to 64"],
                [col(76 / 80), "65 to 79"], [col(1), ">80"]]
                    .reverse()
            }
            return opts
        }



        //style
        const s = new gviz.CompositionStyle({
            color: getColorDict(),
            type: () => "ring",
            sizeCol: "Ind",
            size: (v, r, s, zf) => r * gviz.s(v / s.max, 0.1, 0),
            agePyramidHeight: (r) => 0.95 * r
        }).addLegend(getLegendOpts())
        s.size_ = (v, r, s, zf) => r - 1.5 * zf


        const ttfun = c => {
            let out = "<b>" + c["Ind"] + "</b> inhabitant(s)<br>" + "By age:<br>"
            if (getAggUI()) {
                out = out + "  < 18: " + d3.format(".1f")(c["Ind_0_17"]) + "<br>" +
                    " 18-64: " + d3.format(".1f")(c["Ind_18_64"]) + "<br>" +
                    "  > 65: " + d3.format(".1f")(c["Ind_65p"]) + "<br>" +
                    " unk.: " + d3.format(".1f")(c["Ind_inc"]) + "<br>";
                /*out = out + "  < 24: " + d3.format(".1f")(c["Ind_0_24"]) + "<br>" +
                " 25-54: " + d3.format(".1f")(c["Ind_25_54"]) + "<br>" +
                "  > 55: " + d3.format(".1f")(c["Ind_55p"]) + "<br>" +
                " unk.: " + d3.format(".1f")(c["Ind_inc"]) + "<br>";*/
            } else {
                out = out + " < 3 : " + (c["Ind_0_3"]) + "<br>" +
                    " 4-5 : " + (c["Ind_4_5"]) + "<br>" +
                    " 6-10: " + (c["Ind_6_10"]) + "<br>" +
                    "11-17: " + (c["Ind_11_17"]) + "<br>" +
                    "18-24: " + (c["Ind_18_24"]) + "<br>" +
                    "25-39: " + (c["Ind_25_39"]) + "<br>" +
                    "40-54: " + (c["Ind_40_54"]) + "<br>" +
                    "55-64: " + (c["Ind_55_64"]) + "<br>" +
                    "65-79: " + (c["Ind_65_79"]) + "<br>" +
                    " > 80: " + (c["Ind_80p"]) + "<br>" +
                    " unk.: " + (c["Ind_inc"]) + "<br>";
            }
            return out
        }

        preprocess = c => {
            c["Ind_0_17"] = +c["Ind_0_3"] + +c["Ind_4_5"] + +c["Ind_6_10"] + +c["Ind_11_17"]
            c["Ind_18_64"] = +c["Ind_18_24"] + +c["Ind_25_39"] + +c["Ind_40_54"] + +c["Ind_55_64"]
            c["Ind_65p"] = +c["Ind_65_79"] + +c["Ind_80p"]
            //c["Ind_0_24"] = +c["Ind_0_3"] + +c["Ind_4_5"] + +c["Ind_6_10"] + +c["Ind_11_17"] + +c["Ind_18_24"]
            //c["Ind_25_54"] = +c["Ind_25_39"] + +c["Ind_40_54"]
            //c["Ind_55p"] = +c["Ind_55_64"] + +c["Ind_65_79"] + +c["Ind_80p"]
        }

        const url = "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi_2015/";
        app.addMultiScaleTiledGridLayer(url,
            [
                { code: "200m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "400m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "1000m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "2000m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "5000m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "10000m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "20000m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
                { code: "50000m/", styles: [getStyle()], opts: { cellInfoHTML: ttfun, preprocess: preprocess } },
            ],
            //[0, 5, 10, 25, 50, 125, 250, 500, 1250]
            //[0, 10, 20, 50, 100, 250, 500, 1000, 2500]
            [0, 15, 30, 75, 150, 375, 750, 1500, 3750]
            //[0, 20, 40, 100, 200, 500, 1000, 2000, 5000]
        )

        const updateStyle = () => {
            const ssel = getStyle()
            const ml = app.layers[0];
            ml.hideLegends()
            for (const lay of ml.layers) lay.styles = [ssel]
        }

        //combo list
        document.querySelector('#style').addEventListener('change', function () {
            updateStyle()
            app.cg.redraw();
        });

        // size adaptation
        document.querySelector('#adsize').addEventListener('change', function () {
            const swap = (s, col) => { const aux = s[col]; s[col] = s[col + "_"]; s[col + "_"] = aux }
            swap(s, "size")
            updateStyle()
            app.cg.redraw();
        });



        // aggregation
        document.querySelector('#agg').addEventListener('change', function () {
            s.addLegend(getLegendOpts())
            s.color = getColorDict()
            app.cg.redraw();
        });

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw();
        });

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            app.showBoundaries = this.checked
            app.cg.redraw();
        });

    </script>

    <div
        style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
        <span style="font-size: 8pt;"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration:none">GridViz</a> |
            © <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
    </div>

</body>

</html>