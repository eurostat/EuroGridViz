<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <canvas id="vacanvas" style="height:100%; width:100%;"></canvas>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFEE; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <span style="font-size: 17pt; font-weight: bold;">France agée et France jeune</span>
        <br>
        <fieldset id="style" style="font-size: 13px;">
            <legend>Style</legend>
            <div>
                <input type="radio" name="style" id="square" value="square">
                <label for="square">Square</label>
            </div>
            <div>
                <input type="radio" name="style" id="circle" value="circle">
                <label for="circle">Circle</label>
            </div>
            <div>
                <input type="radio" name="style" id="donut" value="donut" checked>
                <label for="donut">Donut</label>
            </div>
            <div>
                <input type="radio" name="style" id="lineup" value="lineup">
                <label for="lineup">Lineup</label>
            </div>
            <div>
                <input type="radio" name="style" id="hseg" value="hseg">
                <label for="hseg">Horizontal segments</label>
            </div>
            <div>
                <input type="radio" name="style" id="vseg" value="vseg">
                <label for="vseg">Vertical segments</label>
            </div>
            <div>
                <input type="radio" name="style" id="oseg" value="oseg">
                <label for="oseg">Oblique segments</label>
            </div>
            <div>
                <input type="radio" name="style" id="text" value="text">
                <label for="text">Text</label>
            </div>
        </fieldset>
        <span style="font-size: 10pt;">
            Source: <a href="https://www.insee.fr/fr/statistiques/4176290?sommaire=4176305" target="_blank"
                rel="noopener noreferrer">INSEE - Filosofi 2015 - 200m grid</a></span>
    </div>

    <script src="../build/gridvizc.js"></script>
    <script>

        //make application
        const app = new gviz.App()
            .setGeoCenter({ x: 3700000, y: 2760000 }).setZoomFactor(50).setZoomFactorExtent([15, 3000])
            .setLabelLayer(gviz.getEuronymeLabelLayer("FR", "20", { color: () => "white", haloColor: () => "black" }))
            .setBoundaryLayer(gviz.getEurostatBoundariesLayer())
            .setBackgroundColor("#000")

        //test view from URL parameters, if any
        app.cg.setViewFromURL()

        //donut style
        const s = new gviz.ShapeColorSizeStyle({
            sizeCol: "Ind",
            //size: (v, r, s, zf) => r * Math.pow(v / s.max, 0.25),
            size: (v, r, s, zf) => r * Math.pow(v / s.max, 0.2),
            /*size: (v, r, s, zf) => {
                let out = Math.pow(v / s.max, 0.3);
                out = Math.ceil(out * 5);
                out = out / 5;
                return out;
            },*/
            colorCol: "age_ratio",
            //color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow(v, 1.5)),
            color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow(v, 1)),
            shape: () => "donut",
            zfStroke: 30
        })

        //segment
        const sSegment = new gviz.SegmentStyle({
            orientation: () => 0,
            colorCol: "age_ratio",
            color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow(v, 1)),
            length: (v, r) => r,
            widthCol: "Ind",
            width: (v, r, s, zf) => r * Math.pow(v / s.max, 0.25),
        })

        //lineup
        const sLineup = new gviz.LineUpStyle({
            colorCol: "age_ratio",
            color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow(v, 1)),
            heightCol: "Ind",
            height: (v, r, s, z) => 15 * r * Math.pow(v / s.max, 0.6),
        })

        //text
        const sText = new gviz.TextStyle({
            textCol: "age_ratio",
            text: (v, r, s) => "" + Math.trunc(100 * v),
            colorCol: "age_ratio",
            color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow(v, 1)),
            fontSizeCol: "Ind",
            fontSize: (v, r, s, z) => (5 + 1.0 * r * Math.pow(v / s.max, 0.2)),
        })

        const ttfun = c => "<b>" + c["Ind"] + "</b> inhabitant(s)<br>Below 25: " + c.yyy + "<br>Above 55: " + c.ooo;
        const pp = c => {
            c.yyy = +c["Ind_0_3"] + +c["Ind_4_5"] + +c["Ind_6_10"] + +c["Ind_11_17"] + +c["Ind_18_24"];
            c.ooo = +c["Ind_55_64"] + +c["Ind_65_79"] + +c["Ind_80p"]
            c.age_ratio = c.yyy / (c.yyy + c.ooo);
            //if(isNaN(c.age_ratio)) console.log(c)
        }
        const url = "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi_2015/";
        app.addTiledGridLayer(url + "200m/", [s], 0, 20, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "400m/", [s], 20, 40, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "1000m/", [s], 40, 100, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "2000m/", [s], 100, 200, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "5000m/", [s], 200, 500, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "10000m/", [s], 500, 1000, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "20000m/", [s], 1000, 2000, { cellInfoHTML: ttfun, preprocess: pp });
        app.addTiledGridLayer(url + "50000m/", [s], 2000, 9999999999, { cellInfoHTML: ttfun, preprocess: pp });

        //style selector
        document.querySelector('#style').addEventListener('change', function () {
            //set style
            const value = document.querySelector('input[name="style"]:checked').value
            let st;
            if (value === "donut") {
                s.setShape(() => "donut")
                st = s
            } else if (value === "square") {
                s.setShape(() => "square")
                st = s
            } else if (value === "circle") {
                s.setShape(() => "circle")
                st = s
            } else if (value === "hseg") {
                sSegment.setOrientation(() => 0)
                sSegment.setLength((v, r) => r)
                st = sSegment
            } else if (value === "vseg") {
                sSegment.setOrientation(() => 90)
                sSegment.setLength((v, r) => r)
                st = sSegment
            } else if (value === "oseg") {
                sSegment.setOrientation(() => -45)
                sSegment.setLength((v, r) => 1.4142 * r)
                st = sSegment
            } else if (value === "lineup") {
                st = sLineup
            } else if (value === "text") {
                st = sText
            }
            //set style
            for (let lay of app.layers) lay.styles = [st]
            //redraw
            app.cg.redraw();
        })



    </script>

    <div
        style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
        <span style="font-size: 8pt;"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration:none">GridViz</a> |
            © <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
    </div>

</body>

</html>